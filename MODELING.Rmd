---
title: "Curve Fitting"
output: html_notebook
---

#0. Load in packages and data

```{r}
library(remotes)
#remotes::install_github("padpadpadpad/rTPC")
library(rTPC)
library(nls.multstart)
library(Rmisc)
library(tidyverse)
library(broom)
library(purrr)
library(ggplot2)
library(ggpubr)
```

```{r}
Larvalcomb <- read.csv( "~/Desktop/GitHub/Pieris/LarvalCombData.csv", header = TRUE)

Larvalcomb$Temperature <- Larvalcomb$Treatment
Larvalcomb$Treatment <- as.factor(Larvalcomb$Treatment)
Larvalcomb$Larv.Dev.Rate <- 1/Larvalcomb$Age.pupa

Pupalcomb <- read.csv("~/Desktop/Github/Pieris/PupalTempData.csv")
Rearingcomb <- read.csv("~/Desktop/Github/Pieris/RearingTempPupalData.csv")
```

# 1. Redo data analysis for larval exerperiment

## Pupal mass

Including intermediates in larval analysis because we don't include them in pupal analysis

### Mean mass and SE

```{r}
pupalmeans <- summarySE(data = Larvalcomb[Larvalcomb$Surv.pupa == "Y" & !is.na(Larvalcomb$Mass.pupa == TRUE), ], measurevar = "Mass.pupa", groupvars = c("Temperature", "Population"))

pupalmeans

pupalmeans$Mass.se <- pupalmeans$se
pupalmeans$Mass.N <- pupalmeans$N

pupalmeans <- pupalmeans %>%
  select(Temperature, Population, Mass.N, Mass.pupa, Mass.se)

```

### Mean dev time and SE (EXCLUDING THIS FOR NOW)

```{r}
#pupaltimemeans <- summarySE(data = data[data$Surv.pupa == "Y", ], measurevar = "Time.pupa", groupvars = c("Mean.Temp", "PupateOk"))

#pupaltimemeans

#pupaltimemeans$Time.se <- pupaltimemeans$se

#pupaltimemeans <- pupaltimemeans %>%
  #select(Mean.Temp, PupateOk, N, Time.pupa, Time.se)
```

### Merge together (EXCLUDING THIS FOR NOW)

```{r}
#pupalmeans <- merge(pupalmeans, pupaltimemeans, by = c("Mean.Temp", "PupateOk", "N"))
```


## Add in development rate

```{r}
pupalratemeans <- summarySE(data = Larvalcomb[Larvalcomb$Surv.pupa == "Y" & !is.na(Larvalcomb$Larv.Dev.Rate == TRUE), ], measurevar = "Larv.Dev.Rate", groupvars = c("Temperature", "Population"))

pupalratemeans

pupalratemeans$Rate.se <- pupalratemeans$se
pupalratemeans$Rate.N <-pupalratemeans$N

pupalratemeans <- pupalratemeans %>%
  select(Temperature, Population, Rate.N, Larv.Dev.Rate, Rate.se)
```


```{r}
pupalmeans <- merge(pupalmeans, pupalratemeans, by = c("Temperature", "Population"))

pupalmeans
```

## Survival to pupation vs temp treatment 

1. Create summary table
2. Create blank table for input
3. Hard code input
4. Graph it

### 1. Create summary table

```{r}
survpercsum <- summarySE(data = Larvalcomb, 
                         measurevar = "Mass.pupa", 
                         groupvars = c("Temperature", "Surv.pupa", "Population"))
```

### 2. Create blank table

```{r}
survdata <- data.frame(Mean.Temp = c(16, 21, 26, 30, 34), 
                       surv.perc = 0, 
                       group = 1)

survdata$Mean.Temp <- as.factor(survdata$Mean.Temp)
survdata$group = as.factor(survdata$group)
```

### 3. Hard code it

```{r}
survdata[1, 2] <- survpercsum[2, 3] / (survpercsum[2, 3] + survpercsum[1, 3])
survdata[2, 2] <- survpercsum[4, 3] / (survpercsum[4, 3] + survpercsum[3, 3])
survdata[3, 2] <- survpercsum[6, 3] / (survpercsum[6, 3] + survpercsum[5, 3])
survdata[4, 2] <- survpercsum[8, 3] / (survpercsum[8, 3] + survpercsum[7, 3])
survdata[5, 2] <- survpercsum[10, 3] / (survpercsum[10, 3] + survpercsum[9, 3])
```

# 2. Fit dev rate curve just for successful pupa and intermediates using rTPC


Change temp to not be a factor
```{r}
#pupalmeans$Mean.Temp <- as.character(pupalmeans$Mean.Temp)
##pupalmeans$Mean.Temp <- as.numeric(pupalmeans$Mean.Temp)

#pupalmeansyes <- pupalmeans[pupalmeans$PupateOk == "Y", ]
```


## For NC first...
Our object is called `r pupalmeans`. 

```{r}
NCpupalmeans <- pupalmeans[pupalmeans$Population == "NC", ]
```


```{r}
fitmodgaussNC <- nls_multstart(data = NCpupalmeans[, c(1, 7)], 
                             Larv.Dev.Rate ~ modifiedgaussian_2006(temp = Temperature, rmax, topt, a, b), 
                             iter = c(5, 5, 5, 5), 
                             start_lower = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussNC)
```

## Modifying Lauren Buckley's code


```{r}
NCd <- as.data.frame(cbind(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate))

colnames(NCd) <- c("temp", "rate")
```


```{r}
d_fits <- nest(NCd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
d_stack <- select(d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(NCd$temp), max(NCd$temp), length.out = 100))
d_preds <- d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
NCMODS <- ggplot(d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'NC Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

NCMODS
```


```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/NCModels.png", NCMODS, width = 8, height = 5)
```

## Compare models using AIC

```{r}
AIC(d_fits[[2]][[1]],d_fits[[3]][[1]], d_fits[[4]][[1]], d_fits[[5]][[1]])
```

Now let's predict to the x-axis and graph that. 


```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

d_preds_two <- d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
NCMODS2 <- ggplot(d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'NC Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

NCMODS2
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/NCModels2.png", NCMODS2, width = 8, height = 5)
```

## Graphing two best models for NC
```{r}
modGR <-ggplot(d_preds_two[c(201:400, 601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Gaussian and Rezende Model For Development Rate') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) + 

modGR

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/modweibull.png", modweibull, width = 8, height = 5)
```

## Getting the final dev rate curve 

```{r}
NCfitmodweibull <- nls_multstart(data = NCpupalmeans[, c(1, 7)], 
                             Larv.Dev.Rate ~ weibull_1995(temp = Temperature, a, topt, b, c), 
                             iter = c(4, 4, 4, 4), 
                             start_lower = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "weibull_1995") - 10,
                             start_upper = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "weibull_1995") + 10, 
                             lower = get_lower_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "weibull_1995"), 
                             upper = get_upper_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "weibull_1995"), 
                             supp_errors = 'Y',
                             convergence_count = FALSE) 

```

```{r}
summary(NCfitmodweibull)
```

```{r}
NCfitmodrezende <- nls_multstart(data = NCpupalmeans[, c(1, 7)], 
                             Larv.Dev.Rate ~ rezende_2019(temp = Temperature, a, topt, b, c), 
                             iter = c(4, 4, 4, 4), 
                             start_lower = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "rezende_2019") - 10,
                             start_upper = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "rezende_2019") + 10, 
                             lower = get_lower_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "rezende_2019"), 
                             upper = get_upper_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "rezende_2019"), 
                             supp_errors = 'Y',
                             convergence_count = FALSE) 

```


```{r}
NCWeibull <- ggplot(d_preds_two[c(601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'NC Weibull Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

NCWeibull
```

## Now for California 

```{r}
CApupalmeans <- pupalmeans[pupalmeans$Population == "CA", ]
```


```{r}
fitmodgaussCA <- nls_multstart(data = CApupalmeans[, c(1, 7)], 
                             Larv.Dev.Rate ~ modifiedgaussian_2006(temp = Temperature, rmax, topt, a, b), 
                             iter = c(5, 5, 5, 5), 
                             start_lower = get_start_vals(CApupalmeans$Temperature, CApupalmeans$Larv.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(CApupalmeans$Temperature, CApupalmeans$Larv.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(CApupalmeans$Temperature, CApupalmeans$Larv.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(CApupalmeans$Temperature, CApupalmeans$Larv.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussCA)
```
```{r}
CAd <- as.data.frame(cbind(CApupalmeans$Temperature, CApupalmeans$Larv.Dev.Rate))

colnames(CAd) <- c("temp", "rate")
```


```{r}
CA_d_fits <- nest(CAd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
CA_d_stack <- select(CA_d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(CAd$temp), max(CAd$temp), length.out = 100))
CA_d_preds <- CA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
CAMODS <- ggplot(CA_d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

CAMODS

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/CAModels.png", CAMODS, width = 8, height = 5)
```


```{r}
AIC(CA_d_fits[[2]][[1]],CA_d_fits[[3]][[1]], CA_d_fits[[4]][[1]], CA_d_fits[[5]][[1]])
```

```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

CA_d_preds_two <- CA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
CAMODS2 <- ggplot(CA_d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

CAMODS2
```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/CAModels2.png", CAMODS2, width = 8, height = 5)
```


```{r}
CAWeibull <- ggplot(CA_d_preds_two[c(601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Weibull Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

CAWeibull
```

```{r}
CARezende <- ggplot(CA_d_preds_two[c(201:400), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Rezende Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

CARezende
```

## Finally for Washington


```{r}
WApupalmeans <- pupalmeans[pupalmeans$Population == "WA", ]
```


```{r}
fitmodgaussWA <- nls_multstart(data = WApupalmeans[, c(1, 7)], 
                             Larv.Dev.Rate ~ modifiedgaussian_2006(temp = Temperature, rmax, topt, a, b), 
                             iter = c(5, 5, 5, 5), 
                             start_lower = get_start_vals(WApupalmeans$Temperature, WApupalmeans$Larv.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(WApupalmeans$Temperature, WApupalmeans$Larv.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(WApupalmeans$Temperature, WApupalmeans$Larv.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(WApupalmeans$Temperature, WApupalmeans$Larv.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussWA)
```


```{r}
WAd <- as.data.frame(cbind(WApupalmeans$Temperature, WApupalmeans$Larv.Dev.Rate))

colnames(WAd) <- c("temp", "rate")
```


```{r}
WA_d_fits <- nest(WAd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
WA_d_stack <- select(WA_d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(CAd$temp), max(CAd$temp), length.out = 100))
WA_d_preds <- WA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
WAMODS <- ggplot(WA_d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

WAMODS

```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/WAModels.png", WAMODS, width = 8, height = 5)
```

```{r}
AIC(WA_d_fits[[2]][[1]],WA_d_fits[[3]][[1]], WA_d_fits[[4]][[1]], WA_d_fits[[5]][[1]])
```

```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

WA_d_preds_two <- WA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
WAMODS2 <- ggplot(WA_d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

WAMODS2
```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/WAModels2.png", WAMODS2, width = 8, height = 5)
```


```{r}
WAWeibull <- ggplot(WA_d_preds_two[c(601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Weibull Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

WAWeibull
```

```{r}
WARezende <- ggplot(WA_d_preds_two[c(201:400), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Rezende Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

WARezende
```

## Now I want to overlap all three weibull curves for the populations and all three rezende curves for the populations

```{r}
WA_d_preds_two$Population <- "WA"
d_preds_two$Population <- "NC"
CA_d_preds_two$Population <- "CA"

AllPopWeibull <- rbind(WA_d_preds_two[c(601:800), ], d_preds_two[c(601:800), ])
AllPopWeibull <-rbind(AllPopWeibull, CA_d_preds_two[c(601:800), ])

AllPopRezende <- rbind(WA_d_preds_two[c(201:400), ], d_preds_two[c(201:400), ])
AllPopRezende <- rbind(AllPopRezende, CA_d_preds_two[c(201:400), ])

CAd$Population <- "CA"
NCd$Population <- "NC"
WAd$Population <- "WA"
AllPopPoints <- rbind(CAd, NCd)
AllPopPoints <- rbind(AllPopPoints, WAd)
```



```{r}
AllWeibull <- ggplot(AllPopWeibull, aes(temp, rate, group = Population, color = Population, linetype= Population, shape = Population)) +
  geom_point(aes(temp, rate, group = Population, color = Population), AllPopPoints, size = 2.25) + 
  geom_line(aes(temp, .fitted), size = 1) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',) +
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size = 12)+
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2)  + 
  scale_color_manual(values = c("#1E88E5", "orange", "lime green")) +
  scale_linetype_manual(values = c("solid", "dashed", "dotted"))

AllWeibull
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/AllPopsWeibull.png", AllWeibull, width = 8, height = 5)
```

### Making a new larval weibull graph which includes the april and august temperatures as a histogram

```{r}
histtemps <- tibble(Mean.Temp = seq((-5), 50, length.out = 200))

solopreds <- augment(NCfitmodrezende, newdata = histtemps)
```

```{r}
weibullwithhist <-ggplot(data = solopreds) +
  geom_line(aes(x = temp, y = .fitted), data = AllPopWeibull[AllPopWeibull$Population == "NC", ], color = "orange", linetype = "dashed", size = 1) +
  geom_line(aes(x = temp, y = .fitted), data = AllPopWeibull[AllPopWeibull$Population == "WA", ], color = "lime green", linetype = "dotted", size = 1) +
  geom_line(aes(x = temp, y = .fitted), data = AllPopWeibull[AllPopWeibull$Population == "CA", ], color = "#1E88E5", linetype = "solid", size = 1) +
  geom_point(aes(x = Temperature,y = Larv.Dev.Rate), data = pupalmeans[pupalmeans$Population == "NC",], color = "orange", shape = 17, size = 3) +
  geom_point(aes(x = Temperature,y = Larv.Dev.Rate), data = pupalmeans[pupalmeans$Population == "WA",], color = "lime green", shape = 15, size = 3) +
  geom_point(aes(x = Temperature,y = Larv.Dev.Rate), data = pupalmeans[pupalmeans$Population == "CA",], color = "#1E88E5", shape = 19, size = 3) +
  theme_bw() +
  labs(x = 'Temperature (ºC)') +
  scale_y_continuous(name = "Development Rate and Relative Temperature Frequency")+ 
                     #sec.axis = sec_axis(trans = ~., name = "Relative Temperature Frequency")) + 
  geom_histogram(data = apriltemps, aes(x = Temperature, y = ..count.. / 5000), color = "lime green", 
                 fill = "lime green", alpha = .5) + 
  geom_histogram(data = augusttemps, aes(x = Temperature, y = ..count.. / 5000), color = "turquoise", 
                 fill = "turquoise", alpha = .5) 


weibullwithhist
```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/AllPopweibullwithhist.png", weibullwithhist, width = 8, height = 5)
```


```{r}
rezendeover0 <- AllPopRezende[AllPopRezende$.fitted>0,]
```


```{r}
rezendewithhist <-ggplot(data = solopreds) +
  geom_line(aes(x = temp, y = .fitted), data = rezendeover0[rezendeover0$Population == "NC", ], color = "orange", linetype = "dashed", size = 1) +
  geom_line(aes(x = temp, y = .fitted), data = rezendeover0[rezendeover0$Population == "WA", ], color = "lime green", linetype = "dotted", size = 1) +
  geom_line(aes(x = temp, y = .fitted), data = rezendeover0[rezendeover0$Population == "CA", ], color = "#1E88E5", linetype = "solid", size = 1) +
  geom_point(aes(x = Temperature,y = Larv.Dev.Rate), data = pupalmeans[pupalmeans$Population == "NC",], color = "orange", shape = 17, size = 3) +
  geom_point(aes(x = Temperature,y = Larv.Dev.Rate), data = pupalmeans[pupalmeans$Population == "WA",], color = "lime green", shape = 15, size = 3) +
  geom_point(aes(x = Temperature,y = Larv.Dev.Rate), data = pupalmeans[pupalmeans$Population == "CA",], color = "#1E88E5", shape = 19, size = 3) +
  theme_bw() +
  labs(x = 'Temperature (ºC)', y= "Development Rate and Relative Temperature Frequency",
    sec.axis = sec_axis(trans = ~., name = "Relative Temperature Frequency")) + 
  geom_histogram(data = apriltemps, aes(x = Temperature, y = ..count.. / 5000), color = "lime green", 
                 fill = "lime green", alpha = .5) + 
  geom_histogram(data = augusttemps, aes(x = Temperature, y = ..count.. / 5000), color = "turquoise", 
                 fill = "turquoise", alpha = .5) +
  xlim(-5, 50)


rezendewithhist
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/AllPopRezendewithhist.png", rezendewithhist, width = 8, height = 5)
```

```{r}
AllRezende <- ggplot(AllPopRezende, aes(temp, rate, group = Population, color = Population, shape = Population, linetype = Population)) +
  geom_point(aes(temp, rate, group = Population, color = Population), AllPopPoints, size = 2.25) + 
  geom_line(aes(temp, .fitted), size = 1) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate') +
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size = 12)+
  font("legend.title", size= 15)+
  font("legend.text", size = 12)+
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2)  + 
  scale_color_manual(values = c("#1E88E5", "orange", "lime green"))+
  scale_linetype_manual(values = c("solid", "dashed", "dotted"))

AllRezende
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/AllPopsRezende.png", AllRezende, width = 8, height = 5)
```


# 2. April and August NC Data
## Load in our April and August temp data

```{r}
april <- read.csv("~/Desktop/GitHub/Pieris/Realistic_Temp_Data/April_temps.csv", header = TRUE)

august <- read.csv("~/Desktop/GitHub/Pieris/Realistic_Temp_Data/August_temps.csv", header = TRUE)
```

## Create our output datafile

### Cut down by hour

```{r}
aprilhourly <- april[april$V7 == 0, ]
augusthourly <- august[august$V7 == 0, ]
```

```{r}
apriltemps <- tibble(Temperature= aprilhourly$V1) ## Needs to be the same column name as in the model object

augusttemps <- tibble(Temperature = augusthourly$V1)
```


## TANGENT: Graph temp distributions compared to weibull curve

```{r}
histtemps <- tibble(Mean.Temp = seq((-5), 50, length.out = 200))

solopreds <- augment(fitmodweibull, newdata = histtemps)
```

```{r}
weibullwithhist <-ggplot(data = solopreds) +
  geom_line(aes(x = Mean.Temp, y = .fitted), color = "gray") +
  geom_point(aes(x = Mean.Temp,y = Dev.Rate), data = pupalmeansyes, color = "black") +
  theme_bw() +
  labs(x = 'Temperature (ºC)') +
  scale_y_continuous(name = "Development Rate", 
                     sec.axis = sec_axis(trans = ~., name = "Frequency of observed temperatures")) + 
  geom_histogram(data = apriltemps, aes(x = Mean.Temp, y = ..count.. / 5000), color = "lime green", 
                 fill = "lime green", alpha = .5) + 
  geom_histogram(data = augusttemps, aes(x = Mean.Temp, y = ..count.. / 5000), color = "turquoise", 
                 fill = "turquoise", alpha = .5) 


weibullwithhist


```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/weibullwithhist.png", weibullwithhist, width = 8, height = 5)
```


## Get predictions into that datafile

```{r}
aprilpreds <- augment(NCfitmodweibull, newdata = apriltemps)

augustpreds <- augment(NCfitmodweibull, newdata = augusttemps)


aprilpreds$.fitted <- aprilpreds$.fitted / 24

augustpreds$.fitted <- augustpreds$.fitted / 24
```


```{r}
aprilpreds1 <- augment(NCfitmodrezende, newdata = apriltemps)

augustpreds1 <- augment(NCfitmodrezende, newdata = augusttemps)


aprilpreds1$.fitted <- aprilpreds1$.fitted / 24

augustpreds1$.fitted <- augustpreds1$.fitted / 24
```


## Add dev rate until we hit 1, then extract total number of hours (Not doing yet)

```{r}
apriloutput <- data.frame(hour = 1, .fitted = aprilpreds[1, 2])

for(i in 1:length(aprilpreds$.fitted)){
  if(apriloutput[i, 2] >= 1){
    print(apriloutput[i, 1] / 24)
  } else if(apriloutput[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (apriloutput[i, 2] + aprilpreds[i+1, 2]))
    apriloutput <- rbind(apriloutput, newoutput)
  }
}
```


```{r}
apriloutput1 <- data.frame(hour = 1, .fitted = aprilpreds1[1, 2])

for(i in 1:length(aprilpreds1$.fitted)){
  if(apriloutput1[i, 2] >= 1){
    print(apriloutput1[i, 1] / 24)
  } else if(apriloutput1[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (apriloutput1[i, 2] + aprilpreds1[i+1, 2]))
    apriloutput1 <- rbind(apriloutput1, newoutput)
  }
}
```

```{r}
augustoutput <- data.frame(hour = 1, .fitted = augustpreds[1, 2])

for(i in 1:length(augustpreds$.fitted)){
  if(augustoutput[i, 2] >= 1){
    print(augustoutput[i, 1] / 24)
  } else if(augustoutput[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (augustoutput[i, 2] + augustpreds[i+1, 2]))
    augustoutput <- rbind(augustoutput, newoutput)
  }
}
```

```{r}
augustoutput1 <- data.frame(hour = 1, .fitted = augustpreds1[1, 2])

for(i in 1:length(augustpreds1$.fitted)){
  if(augustoutput1[i, 2] >= 1){
    print(augustoutput1[i, 1] / 24)
  } else if(augustoutput1[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (augustoutput1[i, 2] + augustpreds1[i+1, 2]))
    augustoutput1 <- rbind(augustoutput1, newoutput)
  }
}
```


## Get predictions into that datafile - hourly

```{r}
aprilpredstotal <- augment(fitmodweibulltotal, newdata = apriltemps)

augustpredstotal <- augment(fitmodweibulltotal, newdata = augusttemps)


aprilpredstotal$.fitted <- aprilpredstotal$.fitted / 24

augustpredstotal$.fitted <- augustpredstotal$.fitted / 24

```

## Add dev rate until we hit 1, then extract total number of hours 

```{r}
apriloutputtotal <- data.frame(hour = 1, .fitted = aprilpredstotal[1, 2])

for(i in 1:length(aprilpredstotal$.fitted)){
  if(apriloutputtotal[i, 2] >= 1){
    print(apriloutputtotal[i, 1] / 24)
  } else if(apriloutputtotal[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (apriloutputtotal[i, 2] + aprilpredstotal[i+1, 2]))
    apriloutputtotal <- rbind(apriloutputtotal, newoutput)
  }
}
```

```{r}
augustoutputtotal <- data.frame(hour = 1, .fitted = augustpredstotal[1, 2])

for(i in 1:length(augustpredstotal$.fitted)){
  if(augustoutputtotal[i, 2] >= 1){
    print(augustoutputtotal[i, 1] / 24)
  } else if(augustoutputtotal[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (augustoutputtotal[i, 2] + augustpredstotal[i+1, 2]))
    augustoutputtotal <- rbind(augustoutputtotal, newoutput)
  }
}
```


# 3. Fit all to daily temp means

```{r}
aprdailymeans <- data.frame(Mean.Temp = 0)

april$V10 <- april$V8 + 1
```

### Get daily mean temperatures

```{r}
for(i in 1:length(unique(april$V10))){
  subset <- april[april$V10 == i, ]
  meanval <- mean(subset$V1)
  aprdailymeans <- rbind(aprdailymeans, meanval)
}
```

```{r}
aprdailymeans <- aprdailymeans[2:62, ]

aprdailymeans <- tibble(Temperature = aprdailymeans)
```

## Do the prediction part

```{r}
aprildailypreds <- augment(NCfitmodweibull, newdata = aprdailymeans)
```

## Add dev rate until we hit 1, then extract total number of days

```{r}
aprildailyoutput <- data.frame(day = 1, .fitted = aprildailypreds[1, 2])

for(i in 1:length(aprildailypreds$.fitted)){
  if(aprildailyoutput[i, 2] >= 1){
    print(aprildailyoutput[i, 1])
  } else if(aprildailyoutput[i, 2] < 1){
    newoutput <- data.frame(day = i+1, .fitted = (aprildailyoutput[i, 2] + aprildailypreds[i+1, 2]))
    aprildailyoutput <- rbind(aprildailyoutput, newoutput)
  }
}
```

Much slower

## AUGUST


```{r}
augdailymeans <- data.frame(Mean.Temp = 0)

august$V10 <- august$V8 + 1
```

```{r}
for(i in 1:length(unique(august$V10))){
  subset <- august[august$V10 == i, ]
  #print(subset)
  meanval <- mean(subset$V1)
  augdailymeans <- rbind(augdailymeans, meanval)
}
```

```{r}
augdailymeans <- augdailymeans[2:32, ]

augdailymeans <- tibble(Temperature = augdailymeans)
```

## Do the prediction part

```{r}
augustdailypreds <- augment(NCfitmodweibull, newdata = augdailymeans)
```

## Add dev rate until we hit 1, then extract total number of days

```{r}
augustdailyoutput <- data.frame(day = 1, .fitted = augustdailypreds[1, 2])

for(i in 1:length(augustdailypreds$.fitted)){
  if(augustdailyoutput[i, 2] >= 1){
    print(augustdailyoutput[i, 1])
  } else if(augustdailyoutput[i, 2] < 1){
    newoutput <- data.frame(day = i+1, .fitted = (augustdailyoutput[i, 2] + augustdailypreds[i+1, 2]))
    augustdailyoutput <- rbind(augustdailyoutput, newoutput)
  }
}
```

Right on the money this time




# 4. Pupal development rate models for the three populations 


## Development rate

```{r}
Pupalcomb$Pup.Dev.Rate <- 1/Pupalcomb$DaysPtoE
```


```{r}
adultratemeans <- summarySE(data = Pupalcomb[Pupalcomb$Surv.eclose == "Yes" & !is.na(Pupalcomb$Pup.Dev.Rate == TRUE), ], measurevar = "Pup.Dev.Rate", groupvars = c("Treatment", "Population"))

adultratemeans$Rate.se <- adultratemeans$se
adultratemeans$Rate.N <-adultratemeans$N

adultratemeans <- adultratemeans %>%
  select(Treatment, Population, Rate.N, Pup.Dev.Rate, Rate.se)
```


## Survival to pupation vs temp treatment 

1. Create summary table
2. Create blank table for input
3. Hard code input
4. Graph it

### 1. Create summary table

```{r}
survpercsum <- summarySE(data = Pupalcomb, 
                         measurevar = "Mass.pupa", 
                         groupvars = c("Temperature", "Surv.pupa", "Population"))
```

### 2. Create blank table

```{r}
survdata <- data.frame(Mean.Temp = c(16, 21, 26, 30, 34), 
                       surv.perc = 0, 
                       group = 1)

survdata$Mean.Temp <- as.factor(survdata$Mean.Temp)
survdata$group = as.factor(survdata$group)
```

### 3. Hard code it

```{r}
survdata[1, 2] <- survpercsum[2, 3] / (survpercsum[2, 3] + survpercsum[1, 3])
survdata[2, 2] <- survpercsum[4, 3] / (survpercsum[4, 3] + survpercsum[3, 3])
survdata[3, 2] <- survpercsum[6, 3] / (survpercsum[6, 3] + survpercsum[5, 3])
survdata[4, 2] <- survpercsum[8, 3] / (survpercsum[8, 3] + survpercsum[7, 3])
survdata[5, 2] <- survpercsum[10, 3] / (survpercsum[10, 3] + survpercsum[9, 3])
```

# 2. Fit dev rate curve just for successful pupa and intermediates using rTPC


Change temp to not be a factor
```{r}
#pupalmeans$Mean.Temp <- as.character(pupalmeans$Mean.Temp)
##pupalmeans$Mean.Temp <- as.numeric(pupalmeans$Mean.Temp)

#pupalmeansyes <- pupalmeans[pupalmeans$PupateOk == "Y", ]
```


## For NC first...
Our object is called `r pupalmeans`. 

```{r}
NCadultmeans <-adultratemeans[adultratemeans$Population == "NC", ]
```


```{r}
fitmodgaussNC <- nls_multstart(data = NCadultmeans[, c(1, 4)], 
                             Pup.Dev.Rate ~ modifiedgaussian_2006(temp = Treatment, rmax, topt, a, b), 
                             iter = c(5, 5, 5, 5), 
                             start_lower = get_start_vals(NCadultmeans$Treatment, NCadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(NCadultmeans$Treatment, NCadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(NCadultmeans$Treatment, NCadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(NCadultmeans$Treatment, NCadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussNC)
```

## Modifying Lauren Buckley's code


```{r}
NCd <- as.data.frame(cbind(NCadultmeans$Treatment, NCadultmeans$Pup.Dev.Rate))

colnames(NCd) <- c("temp", "rate")
```


```{r}
d_fits <- nest(NCd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
d_stack <- select(d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(NCd$temp), max(NCd$temp), length.out = 100))
d_preds <- d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
NCMODS <- ggplot(d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'NC Pupal Dev Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

NCMODS
```


```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/NCPupalModels.png", NCMODS, width = 8, height = 5)
```

## Compare models using AIC

```{r}
AIC(d_fits[[2]][[1]],d_fits[[3]][[1]], d_fits[[4]][[1]], d_fits[[5]][[1]])
```

Now let's predict to the x-axis and graph that. 


```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

d_preds_two <- d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
y_lims <- c(0, 0.16)

NCMODS2 <- ggplot(d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'NC Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)+
  scale_y_continuous(limits = y_lims)

NCMODS2
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/NCPupalDevModels.png", NCMODS2, width = 8, height = 5)
```

## Graphing two best models for NC (NOT DOING YET)
```{r}
modGR <-ggplot(d_preds_two[c(201:400, 601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Gaussian and Rezende Model For Development Rate') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) + 

modGR

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/modweibull.png", modweibull, width = 8, height = 5)
```

## Getting the final dev rate curve 

```{r}
NCfitmodweibull <- nls_multstart(data = NCpupalmeans[, c(1, 7)], 
                             Larv.Dev.Rate ~ weibull_1995(temp = Temperature, a, topt, b, c), 
                             iter = c(4, 4, 4, 4), 
                             start_lower = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "weibull_1995") - 10,
                             start_upper = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "weibull_1995") + 10, 
                             lower = get_lower_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "weibull_1995"), 
                             upper = get_upper_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "weibull_1995"), 
                             supp_errors = 'Y',
                             convergence_count = FALSE) 

```

```{r}
summary(NCfitmodweibull)
```

```{r}
NCfitmodrezende <- nls_multstart(data = NCpupalmeans[, c(1, 7)], 
                             Larv.Dev.Rate ~ rezende_2019(temp = Temperature, a, topt, b, c), 
                             iter = c(4, 4, 4, 4), 
                             start_lower = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "rezende_2019") - 10,
                             start_upper = get_start_vals(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                          model_name = "rezende_2019") + 10, 
                             lower = get_lower_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "rezende_2019"), 
                             upper = get_upper_lims(NCpupalmeans$Temperature, NCpupalmeans$Larv.Dev.Rate,
                                                    model_name = "rezende_2019"), 
                             supp_errors = 'Y',
                             convergence_count = FALSE) 

```


```{r}
NCWeibull <- ggplot(d_preds_two[c(601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'NC Weibull Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

NCWeibull
```

## Now for California 

```{r}
CAadultmeans <- adultratemeans[adultratemeans$Population == "CA", ]
```


```{r}
fitmodgaussCA <- nls_multstart(data = CAadultmeans[, c(1, 4)], 
                             Pup.Dev.Rate ~ modifiedgaussian_2006(temp = Treatment, rmax, topt, a, b), 
                             iter = c(4, 4, 4, 4), 
                             start_lower = get_start_vals(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussCA)
```
```{r}
CAd <- as.data.frame(cbind(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate))

colnames(CAd) <- c("temp", "rate")
```


```{r}
CA_d_fits <- nest(CAd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
CA_d_stack <- select(CA_d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(CAd$temp), max(CAd$temp), length.out = 100))
CA_d_preds <- CA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
CAMODS <- ggplot(CA_d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Pupal Development Rate Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

CAMODS

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/CAPupalDevModels.png", CAMODS, width = 8, height = 5)
```


```{r}
AIC(CA_d_fits[[2]][[1]],CA_d_fits[[3]][[1]], CA_d_fits[[4]][[1]], CA_d_fits[[5]][[1]])
```

```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

CA_d_preds_two <- CA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
CAMODS2 <- ggplot(CA_d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Pupal Dev Rate Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)+
  scale_y_continuous(limits = y_lims)

CAMODS2
```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/CADevRateModeltoaxis.png", CAMODS2, width = 8, height = 5)
```


```{r}
CAWeibull <- ggplot(CA_d_preds_two[c(601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Weibull Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

CAWeibull
```

```{r}
CARezende <- ggplot(CA_d_preds_two[c(201:400), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Rezende Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

CARezende
```

## Finally for Washington


```{r}
WAadultmeans <- adultratemeans[adultratemeans$Population == "WA", ]
```


```{r}
fitmodgaussWA <- nls_multstart(data = WAadultmeans[, c(1, 4)], 
                             Pup.Dev.Rate ~ modifiedgaussian_2006(temp = Treatment, rmax, topt, a, b), 
                             iter = c(5, 5, 5, 5), 
                             start_lower = get_start_vals(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussWA)
```


```{r}
WAd <- as.data.frame(cbind(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate))

colnames(WAd) <- c("temp", "rate")
```


```{r}
WA_d_fits <- nest(WAd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
WA_d_stack <- select(WA_d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(CAd$temp), max(CAd$temp), length.out = 100))
WA_d_preds <- WA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
WAMODS <- ggplot(WA_d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Pupal Dev Rate Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

WAMODS

```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/WAPupalDevModels.png", WAMODS, width = 8, height = 5)
```

```{r}
AIC(WA_d_fits[[2]][[1]],WA_d_fits[[3]][[1]], WA_d_fits[[4]][[1]], WA_d_fits[[5]][[1]])
```

```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

WA_d_preds_two <- WA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
y_lims<- c(0,.185)
WAMODS2 <- ggplot(WA_d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Adult Dev Rate Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)+
  scale_y_continuous(limits = y_lims)

WAMODS2
```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/WAPupalDevModelstoaxis.png", WAMODS2, width = 8, height = 5)
```


```{r}
WAWeibull <- ggplot(WA_d_preds_two[c(601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Weibull Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

WAWeibull
```

```{r}
WARezende <- ggplot(WA_d_preds_two[c(201:400), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Rezende Curve') +
  ylim(-.01, .1)+
  geom_hline(aes(yintercept = 0), linetype = 2) 

WARezende
```

## Now I want to overlap all three weibull curves for the populations and all three rezende curves for the populations

```{r}
WA_d_preds_two$Population <- "WA"
d_preds_two$Population <- "NC"
CA_d_preds_two$Population <- "CA"

AllPopWeibull <- rbind(WA_d_preds_two[c(601:800), ], d_preds_two[c(601:800), ])
AllPopWeibull <-rbind(AllPopWeibull, CA_d_preds_two[c(601:800), ])

AllPopRezende <- rbind(WA_d_preds_two[c(201:400), ], d_preds_two[c(201:400), ])
AllPopRezende <- rbind(AllPopRezende, CA_d_preds_two[c(201:400), ])

CAd$Population <- "CA"
NCd$Population <- "NC"
WAd$Population <- "WA"
AllPopPoints <- rbind(CAd, NCd)
AllPopPoints <- rbind(AllPopPoints, WAd)
```



```{r}
AllWeibull <- ggplot(AllPopWeibull, aes(temp, rate, group = Population, color = Population, linetype= Population, shape = Population)) +
  geom_point(aes(temp, rate, group = Population, color = Population), AllPopPoints, size = 3) + 
  geom_line(aes(temp, .fitted), size = 1) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',) +
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size = 12)+
  ylim(-.01, .2)+
  geom_hline(aes(yintercept = 0), linetype = 2)  + 
  scale_color_manual(values = c("#1E88E5", "orange", "lime green")) +
  scale_linetype_manual(values = c("solid", "dashed", "dotted"))

AllWeibull
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/AllPopsPupalWeibull.png", AllWeibull, width = 8, height = 5)
```


```{r}
AllRezende <- ggplot(AllPopRezende, aes(temp, rate, group = Population, color = Population, shape = Population, linetype = Population)) +
  geom_point(aes(temp, rate, group = Population, color = Population), AllPopPoints, size = 3) + 
  geom_line(aes(temp, .fitted), size = 1) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate') +
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size = 12)+
  font("legend.title", size= 15)+
  font("legend.text", size = 12)+
  ylim(-.01, .2)+
  geom_hline(aes(yintercept = 0), linetype = 2)  + 
  scale_color_manual(values = c("#1E88E5", "orange", "lime green"))+
  scale_linetype_manual(values = c("solid", "dashed", "dotted"))

AllRezende
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/AllPopsPupalRezende.png", AllRezende, width = 8, height = 5)
```

#5. Doing modeling for pupal stage of the larval experiments (rearing temperature)


## Development rate

```{r}
Rearingcomb$Pup.Dev.Rate <- 1/Rearingcomb$Time.eclose
```


```{r}
radultratemeans <- summarySE(data = Rearingcomb[Rearingcomb$Surv.adult == "Yes" & !is.na(Rearingcomb$Pup.Dev.Rate == TRUE), ], measurevar = "Pup.Dev.Rate", groupvars = c("Treatment", "Population"))

radultratemeans$Rate.se <- radultratemeans$se
radultratemeans$Rate.N <-radultratemeans$N

radultratemeans <- radultratemeans %>%
  select(Treatment, Population, Rate.N, Pup.Dev.Rate, Rate.se)

radultratemeans
```


## Survival to pupation vs temp treatment (NOT DOING YET)

1. Create summary table
2. Create blank table for input
3. Hard code input
4. Graph it

### 1. Create summary table

```{r}
survpercsum <- summarySE(data = Pupalcomb, 
                         measurevar = "Mass.pupa", 
                         groupvars = c("Temperature", "Surv.pupa", "Population"))
```

### 2. Create blank table

```{r}
survdata <- data.frame(Mean.Temp = c(16, 21, 26, 30, 34), 
                       surv.perc = 0, 
                       group = 1)

survdata$Mean.Temp <- as.factor(survdata$Mean.Temp)
survdata$group = as.factor(survdata$group)
```

### 3. Hard code it

```{r}
survdata[1, 2] <- survpercsum[2, 3] / (survpercsum[2, 3] + survpercsum[1, 3])
survdata[2, 2] <- survpercsum[4, 3] / (survpercsum[4, 3] + survpercsum[3, 3])
survdata[3, 2] <- survpercsum[6, 3] / (survpercsum[6, 3] + survpercsum[5, 3])
survdata[4, 2] <- survpercsum[8, 3] / (survpercsum[8, 3] + survpercsum[7, 3])
survdata[5, 2] <- survpercsum[10, 3] / (survpercsum[10, 3] + survpercsum[9, 3])
```

# 2. Fit dev rate curve just for successful pupa and intermediates using rTPC


Change temp to not be a factor
```{r}
#pupalmeans$Mean.Temp <- as.character(pupalmeans$Mean.Temp)
##pupalmeans$Mean.Temp <- as.numeric(pupalmeans$Mean.Temp)

#pupalmeansyes <- pupalmeans[pupalmeans$PupateOk == "Y", ]
```


## For NC first...
Our object is called `r pupalmeans`. 

```{r}
NCradultmeans <-radultratemeans[radultratemeans$Population == "NC", ]
```


```{r}
fitmodgaussNC <- nls_multstart(data = NCradultmeans[, c(1, 4)], 
                             Pup.Dev.Rate ~ modifiedgaussian_2006(temp = Treatment, rmax, topt, a, b), 
                             iter = c(5, 5, 5, 5), 
                             start_lower = get_start_vals(NCradultmeans$Treatment, NCradultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(NCradultmeans$Treatment, NCradultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(NCradultmeans$Treatment, NCradultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(NCradultmeans$Treatment, NCradultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussNC)
```

## Modifying Lauren Buckley's code


```{r}
NCd <- as.data.frame(cbind(NCradultmeans$Treatment, NCradultmeans$Pup.Dev.Rate))

colnames(NCd) <- c("temp", "rate")
```


```{r}
d_fits <- nest(NCd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
d_stack <- select(d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(NCd$temp), max(NCd$temp), length.out = 100))
d_preds <- d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
NCMODS <- ggplot(d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'NC Pupal Dev Model fit comparison (Chronic)') +
  geom_hline(aes(yintercept = 0), linetype = 2)

NCMODS
```


```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/NCPupalModelsREARING.png", NCMODS, width = 8, height = 5)
```

## Compare models using AIC

```{r}
AIC(d_fits[[2]][[1]],d_fits[[3]][[1]], d_fits[[4]][[1]], d_fits[[5]][[1]])
```

Now let's predict to the x-axis and graph that. 


```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

d_preds_two <- d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
y_lims <- c(0, 0.16)

NCMODS2 <- ggplot(d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), NCd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'NC Pupal Dev Rate Model fit comparison (Chronic)') +
  geom_hline(aes(yintercept = 0), linetype = 2)+
  scale_y_continuous(limits = y_lims)

NCMODS2
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/NCPupalDevModelsRearing.png", NCMODS2, width = 8, height = 5)
```

## Now for California 

```{r}
CAradultmeans <- radultratemeans[radultratemeans$Population == "CA", ]
```


```{r}
fitmodgaussCA <- nls_multstart(data = CAradultmeans[, c(1, 4)], 
                             Pup.Dev.Rate ~ modifiedgaussian_2006(temp = Treatment, rmax, topt, a, b), 
                             iter = c(4, 4, 4, 4), 
                             start_lower = get_start_vals(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(CAadultmeans$Treatment, CAadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussCA)
```

```{r}
CAd <- as.data.frame(cbind(CAradultmeans$Treatment, CAradultmeans$Pup.Dev.Rate))

colnames(CAd) <- c("temp", "rate")
```


```{r}
CA_d_fits <- nest(CAd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
CA_d_stack <- select(CA_d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(CAd$temp), max(CAd$temp), length.out = 100))
CA_d_preds <- CA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
CAMODS <- ggplot(CA_d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Pupal Development Rate Model fit comparison (Chronic)') +
  geom_hline(aes(yintercept = 0), linetype = 2)

CAMODS

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/CAPupalDevModelsRearing.png", CAMODS, width = 8, height = 5)
```


```{r}
AIC(CA_d_fits[[2]][[1]],CA_d_fits[[3]][[1]], CA_d_fits[[4]][[1]], CA_d_fits[[5]][[1]])
```

```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

CA_d_preds_two <- CA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
CAMODS2 <- ggplot(CA_d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), CAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'CA Pupal Dev Rate Model fit comparison (Chronic)') +
  geom_hline(aes(yintercept = 0), linetype = 2)+
  scale_y_continuous(limits = y_lims)

CAMODS2
```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/CADevRateModeltoaxisChronic.png", CAMODS2, width = 8, height = 5)
```


## Finally for Washington

```{r}
WAradultmeans <- radultratemeans[radultratemeans$Population == "WA", ]
```


```{r}
fitmodgaussWA <- nls_multstart(data = WAradultmeans[, c(1, 4)], 
                             Pup.Dev.Rate ~ modifiedgaussian_2006(temp = Treatment, rmax, topt, a, b), 
                             iter = c(5, 5, 5, 5), 
                             start_lower = get_start_vals(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(WAadultmeans$Treatment, WAadultmeans$Pup.Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgaussWA)
```


```{r}
WAd <- as.data.frame(cbind(WAradultmeans$Treatment, WAradultmeans$Pup.Dev.Rate))

colnames(WAd) <- c("temp", "rate")
```


```{r}
WA_d_fits <- nest(WAd, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
WA_d_stack <- select(WA_d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
  #mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(CAd$temp), max(CAd$temp), length.out = 100))
WA_d_preds <- WA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
WAMODS <- ggplot(WA_d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Pupal Dev Rate Model fit comparison (chronic)') +
  geom_hline(aes(yintercept = 0), linetype = 2)

WAMODS

```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/WAPupalDevModelsRearing.png", WAMODS, width = 8, height = 5)
```

```{r}
AIC(WA_d_fits[[2]][[1]],WA_d_fits[[3]][[1]], WA_d_fits[[4]][[1]], WA_d_fits[[5]][[1]])
```

```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

WA_d_preds_two <- WA_d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
y_lims<- c(0,.17)
WAMODS2 <- ggplot(WA_d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), WAd) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'WA Adult Dev Rate Model fit comparison (chronic)') +
  geom_hline(aes(yintercept = 0), linetype = 2)+
  scale_y_continuous(limits = y_lims)

WAMODS2
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/WAPupalDevModelstoaxisRearing.png", WAMODS2, width = 8, height = 5)
```

## Now I want to overlap all three weibull curves for the populations and all three rezende curves for the populations

```{r}
WA_d_preds_two$Population <- "WA"
d_preds_two$Population <- "NC"
CA_d_preds_two$Population <- "CA"

AllPopWeibull <- rbind(WA_d_preds_two[c(601:800), ], d_preds_two[c(601:800), ])
AllPopWeibull <-rbind(AllPopWeibull, CA_d_preds_two[c(601:800), ])

AllPopRezende <- rbind(WA_d_preds_two[c(201:400), ], d_preds_two[c(201:400), ])
AllPopRezende <- rbind(AllPopRezende, CA_d_preds_two[c(201:400), ])

CAd$Population <- "CA"
NCd$Population <- "NC"
WAd$Population <- "WA"
AllPopPoints <- rbind(CAd, NCd)
AllPopPoints <- rbind(AllPopPoints, WAd)
```



```{r}
AllWeibull <- ggplot(AllPopWeibull, aes(temp, rate, group = Population, color = Population, linetype= Population, shape = Population)) +
  geom_point(aes(temp, rate, group = Population, color = Population), AllPopPoints, size = 3) + 
  geom_line(aes(temp, .fitted), size = 1) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',) +
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size = 12)+
  ylim(-.01, .2)+
  geom_hline(aes(yintercept = 0), linetype = 2)  + 
  scale_color_manual(values = c("#1E88E5", "orange", "lime green")) +
  scale_linetype_manual(values = c("solid", "dashed", "dotted"))

AllWeibull
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/AllPopsPupalWeibullRearing.png", AllWeibull, width = 8, height = 5)
```


```{r}
AllRezende <- ggplot(AllPopRezende, aes(temp, rate, group = Population, color = Population, shape = Population, linetype = Population)) +
  geom_point(aes(temp, rate, group = Population, color = Population), AllPopPoints, size = 3) + 
  geom_line(aes(temp, .fitted), size = 1) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate') +
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size = 12)+
  font("legend.title", size= 15)+
  font("legend.text", size = 12)+
  ylim(-.01, .2)+
  geom_hline(aes(yintercept = 0), linetype = 2)  + 
  scale_color_manual(values = c("#1E88E5", "orange", "lime green"))+
  scale_linetype_manual(values = c("solid", "dashed", "dotted"))

AllRezende
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/AllPopsPupalRezendeRearing.png", AllRezende, width = 8, height = 5)
```



