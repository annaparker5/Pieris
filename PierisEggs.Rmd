---
title: "Pieris_Egg_Gradient"
output: html_document
date: "2023-08-17"
---
 
 Outline:
 0. Packages and data (north carolina and california)
 1. Analyze temperatures- is there significant differences between days or is the temperature of the column consistent?
 2. Clean Egg Data for North Carolina
 
 
 
# 0. Packages and data
```{r}
TempData <- read.csv("~/Desktop/GitHub/Pieris/Egg_Gradient/Daily_temps_cleaned.csv", header = TRUE)
NCEggGrad <- read.csv("~/Desktop/GitHub/Pieris/NCEggGrad.csv", header = TRUE)
NCEggCham <- read.csv("~/Desktop/Github/Pieris/NCEggChambers.csv", header = TRUE)
CAEggGrad <- read.csv("~/Desktop/Github/Pieris/CAEggGrad.csv", header = TRUE)
```
 
```{r}
library(lmerTest)
library(Rmisc)
library(dplyr)
library(ggplot2)
library(dbplyr)
library(ggpubr)
```

#1. Analyze temperatures 

## Checking warm temperature gradient first
```{r}
warmgrad <- lm(Temperature ~ Column*Date, data = TempData[TempData$Gradient_type == "warm", ])

anova(warmgrad)

summary(warmgrad)
```

## without the interaction term

```{r}
warmgrad <- lm(Temperature ~ Column+Date, data = TempData[TempData$Gradient_type == "warm", ])

anova(warmgrad)

summary(warmgrad)
```

Okay so date is not a signicant indicator of temperature in the warm temperature gradient (I think)

## Now checking the cooler temperature gradient

```{r}
coolgrad <- lm(Temperature ~ Column*Date, data = TempData[TempData$Gradient_type == "cool", ])

anova(coolgrad)

summary(coolgrad)
```

There might be something going on on June 22nd... 

## Without the interaction term

```{r}
coolgrad <- lm(Temperature ~ Column+Date, data = TempData[TempData$Gradient_type == "cool", ])

anova(coolgrad)

summary(coolgrad)
```

Might need to take a closer look at the 20th and 23rd unless I'm mistaken

#2. Egg Gradient Analysis (NC)

## Development Rate
```{r}
DevEgg <- NCEggGrad %>%
  select(ID, Hours_calculated, Avg_temp)

DevEgg <- DevEgg[complete.cases(DevEgg), ]

```

```{r}
DevEgg$Dev.rate <- 1/DevEgg$Hours_calculated
DevEgg$Population <- "NC"
```


```{r}
NCEggDevGraph <- ggplot(data = DevEgg, aes(x = Avg_temp, y = Dev.rate)) + 
  theme_bw() + 
  geom_point(size = 3) + 
  geom_smooth(method= "lm")
  labs(x = "Average Temperature", y = "Development Rate (1/hours to hatch)")
NCEggDevGraph

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/NCEggDevRate.png", NCEggDevGraph, width = 8, height = 5)
```


```{r}
NCEggGrad$Block <- NA

for (i in 1:length(NCEggGrad$Block)){
  if(i < 97){
    NCEggGrad[i,10] <- "1G"
  } else if(i > 98){
    NCEggGrad[i,10] <- "2G"
  }
}

```

```{r}
NCEggGrad$Hatch.Ok <- NA

for (i in 1:length(NCEggGrad$Hatch.Ok)){
  if(is.na(NCEggGrad[i,7])== TRUE){
    NCEggGrad[i,11] <- "No"
  } else if(is.na(NCEggGrad[i,7])== FALSE){
    NCEggGrad[i,11] <- "Yes"
  }
}
```

```{r}
NCEggGrad$Dev.rate <- 1/NCEggGrad$Days_to_hatch

NCEggGrad$Expt <- "Gradient"
```



#3. Egg Gradient Analysis (CA)

## Development Rate
```{r}
DevEggCA <- CAEggGrad %>%
  select(ID, Hours_calculated, Avg_temp)

DevEggCA <- DevEggCA[complete.cases(DevEggCA), ]

```

```{r}
DevEggCA$Dev.rate <- 1/DevEggCA$Hours_calculated
DevEggCA$Population <- "CA"
```


```{r}
CAEggDevGraph <- ggplot(data = DevEggCA, aes(x = Avg_temp, y = Dev.rate)) + 
  theme_bw() + 
  geom_point(size = 3) + 
  geom_smooth(method= "lm")
  labs(x = "Average Temperature", y = "Development Rate (1/hours to hatch)")
CAEggDevGraph

```
```{r}
ggsave("~/Desktop/GitHub/Pieris/CAEggDevRate.png", CAEggDevGraph, width = 8, height = 5)
```

```{r}
CombEggGradData <- rbind(DevEggCA, DevEgg)
```

```{r}
CombEggGradGraph <- ggplot(data = CombEggGradData,  aes(x = Avg_temp, y = Dev.rate, group = Population, color = Population, linetype = Population, shape = Population)) +
  theme_bw() + 
  geom_point(size = 3) + 
  geom_smooth(method= "lm", se = FALSE) +
  xlim(12, 35) +
  scale_color_manual(values = c("#1E88E5", "orange")) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  scale_shape_manual(values = c(19, 17)) + 
  labs(x = "Average Temperature", y = "Development Rate (1/hours to hatch)")
  
CombEggGradGraph
```
```{r}
ggsave("~/Desktop/GitHub/Pieris/NCCAEggDevRate.png", CombEggGradGraph, width = 8, height = 5)
```


## Survival 

```{r}
EggGradSurv <- select(NCEggGrad, Column, Avg_temp, Block, Hatch.Ok, Days_to_hatch, Expt)
```

```{r}
GradSurvSum <- summarise(EggGradSurv)
```



#3. Egg Chamber Analysis (NC)

```{r}
ChamberBlocks <- glm(Time.Hatch ~ Block*Treatment, data = NCEggCham)

anova(ChamberBlocks, test = "Chisq")

summary(ChamberBlocks)

AIC(Chamber)
```

```{r}
ChamberBlocks1 <- glm(Time.Hatch ~ Block*poly(Treatment,2), data = NCEggCham)

anova(ChamberBlocks1, test = "Chisq")

AIC(ChamberBlocks1) #1114.976
```
```{r}
anova(ChamberBlocks1, ChamberBlocks2)
```



There is a significant block effect in the egg chamber data...

 Egg Chamber Development Rate 
```{r}
NCEggCham$Dev.rate <- 1/NCEggCham$Time.Hatch
NCEggCham$Expt <- "Chamber"

for (i in 1:length(NCEggCham$Hatch.Ok)){
  if(is.na(NCEggCham[i,8])== TRUE){
    NCEggCham[i,6] <- "No"
  } else if(is.na(NCEggCham[i,8])== FALSE){
    NCEggCham[i,6] <- "Yes"
  }
}
```


```{r}
colnames(NCEggCham)[3]<- "Avg_temp"
```


This one is separated by block
```{r}
EggChamSum <- summarySE(data = NCEggCham[NCEggCham$Hatch.Ok == "Yes", ], measurevar = "Dev.rate", groupvars = c("Avg_temp", "Block"))

EggChamSum$Block <- as.factor(EggChamSum$Block)
EggChamSum$Avg_temp <- as.factor(EggChamSum$Avg_temp)
EggChamSum %>% 
  select(Avg_temp, Block, N, Dev.rate, se)
```

This one is NOT separated by block
```{r}
EggChamSumTot <- summarySE(data = NCEggCham[NCEggCham$Hatch.Ok == "Yes", ], measurevar = "Dev.rate", groupvars = c("Avg_temp"))

EggChamSumTot$Avg_temp <- as.factor(EggChamSumTot$Avg_temp)
EggChamSumTot %>% 
  select(Avg_temp, N, Dev.rate, se)
```



```{r}
EggChamDevGraph <- ggplot(data = EggChamSum, aes(x = Avg_temp, y = Dev.rate, group = Block, color = Block)) + 
  theme_bw() + 
  geom_errorbar(aes(ymin = Dev.rate - se, ymax = Dev.rate + se)) + 
  geom_point(size = 3) + 
  scale_color_manual(values = c("#1E88E5","lime green")) + 
  labs(x = "Average Temperature", y = "Development Rate (1/days to hatch)")

EggChamDevGraph
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/NCChamberEggDevRate.png", EggChamDevGraph, width = 8, height = 5)
```

This one is separted by block
```{r}
Eggchamdev <- ggplot(data = EggChamSum, aes(x = Avg_temp, y = Dev.rate, group = Block, linetype = Block, color = Block, label = N)) +
  theme_bw() + 
  geom_point(size = 3.5) + 
  geom_line(size = 1.5) +
  labs(x = "Mean Temperature (°C)", y = "Development Rate", group = "Block", linetype = "Block", 
       shape = "Block") +
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size= 12)+
  font("legend.title", size = 15)+
  font("legend.text", size = 12)+
  scale_linetype_manual(values = c("solid", "dashed")) + 
  scale_color_manual(values = c("#1E88E5", "#ED68DD"))+
  geom_errorbar(aes(ymin = Dev.rate - se, ymax = Dev.rate + se), width = 0.3, linetype = "solid")

Eggchamdev
```


This one is not separated by block
```{r}
Eggchamdevtot <- ggplot(data = EggChamSumTot, aes(x = Avg_temp, y = Dev.rate, label = N, colour = "orange", linetype = , shape = "triangle")) +
  theme_bw() + 
  geom_point(size = 3.5) + 
  geom_line(size = 1.5) +
  labs(x = "Mean Temperature (°C)", y = "Development Rate") +
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size= 12)+
  font("legend.title", size = 15)+
  font("legend.text", size = 12)+
  scale_linetype_manual(values = c("dashed")) + 
  scale_color_manual(values = c("orange"))+
  scale_shape_manual(values = c(17))+
  geom_errorbar(aes(ymin = Dev.rate - se, ymax = Dev.rate + se), width = 0.3, linetype = "solid")

Eggchamdevtot
```



```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/EggDevRate.png", Eggchamdev, width = 8, height = 5)
```

Egg chamber survival analysis

```{r}
EggChamSurv <- summarySE(data = NCEggCham, measurevar = "Dev.rate", groupvars = c("Avg_temp", "Block", "Hatch.Ok"))

EggChamSurv

EggChamSurv$Block <- as.factor(EggChamSurv$Block)
EggChamSurv$Avg_temp <- as.factor(EggChamSurv$Avg_temp)
EggChamSurv %>%
  select(Avg_temp, Block, Hatch.Ok, N)
```

```{r}
EggChamSurvData <- data.frame(Mean.Temp = c(16, 21, 26, 30, 34, 16, 21, 26, 30, 34), 
                       surv.perc = 0,
                       Block = c("1","1","1","1","1","2","2","2","2","2"),
                       number = 0,
                       se = 0)

EggChamSurvData[1, 2] <- EggChamSurv[2, 4] / (EggChamSurv[1, 4] + EggChamSurv[2, 4])
EggChamSurvData[2, 2] <- EggChamSurv[6, 4] / (EggChamSurv[6, 4] + EggChamSurv[5, 4])
EggChamSurvData[3, 2] <- EggChamSurv[10, 4] / (EggChamSurv[10, 4] + EggChamSurv[9, 4])
EggChamSurvData[4, 2] <- EggChamSurv[14, 4] / (EggChamSurv[14, 4] + EggChamSurv[13, 4])
EggChamSurvData[5, 2] <- 0
EggChamSurvData[6, 2] <- EggChamSurv[4, 4] / (EggChamSurv[4, 4] + EggChamSurv[3, 4])
EggChamSurvData[7, 2] <- EggChamSurv[8, 4] / (EggChamSurv[8, 4] + EggChamSurv[7, 4])
EggChamSurvData[8, 2] <- EggChamSurv[12, 4] / (EggChamSurv[12, 4] + EggChamSurv[11, 4])
EggChamSurvData[9, 2] <- EggChamSurv[16, 4] / (EggChamSurv[16, 4] + EggChamSurv[15, 4])
EggChamSurvData[10, 2] <- EggChamSurv[19, 4] / (EggChamSurv[19, 4] + EggChamSurv[18, 4])

EggChamSurvData[1, 4] <- (EggChamSurv[1, 4] + EggChamSurv[2, 4])
EggChamSurvData[2, 4] <- (EggChamSurv[6, 4] + EggChamSurv[5, 4])
EggChamSurvData[3, 4] <- (EggChamSurv[10, 4] + EggChamSurv[9, 4])
EggChamSurvData[4, 4] <- (EggChamSurv[14, 4] + EggChamSurv[13, 4])
EggChamSurvData[5, 4] <- 68
EggChamSurvData[6, 4] <- (EggChamSurv[4, 4] + EggChamSurv[3, 4])
EggChamSurvData[7, 4] <- (EggChamSurv[8, 4] + EggChamSurv[7, 4])
EggChamSurvData[8, 4] <- (EggChamSurv[12, 4] + EggChamSurv[11, 4])
EggChamSurvData[9, 4] <- (EggChamSurv[16, 4] + EggChamSurv[15, 4])
EggChamSurvData[10, 4] <- (EggChamSurv[19, 4] + EggChamSurv[18, 4])
                                                                            
```

```{r}
for (i in 1:length(EggChamSurvData$se)){
  EggChamSurvData[i,5] = sqrt((EggChamSurvData[i,2]*(1-EggChamSurvData[i,2]))/EggChamSurvData[i,4])
}
```


```{r}
eggchamsurvgraph <- ggplot(data = EggChamSurvData, aes(x = Mean.Temp, y = surv.perc, group = Block, color = Block, linetype = Block, label = number)) + 
  #geom_text(hjust=-.5, vjust=0)+
  theme_bw() + 
  geom_point(size = 3.5) + 
  geom_line(size = 1.5) + 
  font("xy", size = 15)+
  font("x.text", size = 12)+
  font("y.text", size= 12)+
  font("legend.title", size = 15)+
  font("legend.text", size = 12)+
  ylim(0, 1) + 
  scale_color_manual(values = c("#1E88E5", "#ED68DD")) + 
  scale_linetype_manual(values = c("solid", "dashed")) + 
  labs(x = "Mean Temperature (°C)", y = "Proportion survival to hatching") +
  geom_errorbar(aes(ymin = surv.perc - se, ymax = surv.perc + se), width = 1, linetype = "solid")

eggchamsurvgraph
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Thesis/EggSurvival.png", eggchamsurvgraph, width = 8, height = 5)
```


#4. Combining Egg Chamber and Egg Gradient for NC
Lets try and graph all of the points of both egg chamber and egg gradient on one graph, separating by blocks 

```{r}
Chambershort <- select(NCEggCham, Avg_temp, Hatch.Ok, Block, Dev.rate, Expt)
Gradientshort <- select(NCEggGrad, Avg_temp, Hatch.Ok, Block, Dev.rate, Expt)

AllNCEggData<- rbind(Chambershort, Gradientshort)

```


```{r}
AllNCEggDev <- ggplot(data = AllNCEggData[AllNCEggData$Hatch.Ok == "Yes", ], aes(x = Avg_temp, y = Dev.rate, color = Expt, shape = Block)) + 
  theme_bw() + 
  geom_point(size = 3) + 
  scale_color_manual(values = c("#1E88E5","lime green", "orange", "purple")) + 
  scale_shape_manual(values = c(16, 15, 17, 18))+
  labs(x = "Average Temperature", y = "Development Rate (1/days to hatch)")
  
AllNCEggDev
```

```{r}
ggsave("~/Desktop/GitHub/Pieris/NCEggComp_Color1.png", AllNCEggDev, width = 8, height = 5)
```




#Linear modeling statistics

```{r}
NCEggCham$Temperature <- NCEggCham$Treatment
NCEggCham$Treatment <- as.factor(NCEggCham$Treatment)
```


```{r}
eggdev <- glm(Time.Hatch ~ Avg_temp*Block, data = NCEggCham[NCEggCham$Hatch.Ok == "Yes", ])

summary(eggdev)
anova(eggdev, test = "Chisq")
```

```{r}
NCEggCham <- NCEggCham %>%
  mutate(Hatch.Ok = case_when(Hatch.Ok == "Yes" ~ 1,
                              Hatch.Ok == "No" ~ 0))

eggsurv <- glm(Hatch.Ok ~ Avg_temp*Block, data = NCEggCham, family = binomial(link="logit"))

summary(eggsurv)
anova(eggsurv, test = "Chisq")
```

```{r}
eggdev <- glm(Time.Hatch ~ Treatment*Block, data = NCEggCham)

summary(eggdev)
anova(eggdev, test = "Chisq")

summary(aov(Dev.rate ~ Avg_temp, data = NCEggCham))
```

```{r}
eggsurv <- glm(Hatch.Ok ~ Treatment*Block, data = NCEggCham, family = binomial(link="logit"))

summary(eggsurv)
anova(eggsurv, test = "Chisq")
```








