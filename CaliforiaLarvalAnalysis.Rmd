---
title: "California_Larval_Analysis"
output: html_document
date: "2023-08-08"
---

This is script to clean California larval experiment from Summer 2023, and begin data analysis on these data.

0. Load in data
1. Fill unfilled columns for survival at each stage
2. Get means for all that survived to eclosion
3. Get means for all that survived to pupation (but not necessarily eclosion)
4. Graph!


# 0. Load in data and packages
```{r}
library(dplyr)
library(tidyverse)
```

```{r}
CaliLarvalData <- read.csv("~/Desktop/GitHub/Pieris/California/CALarval/CAPierisLarvalData.csv", header = TRUE)

CaliLarvalData
```

## Converting Mass.adult column from character to numeric
``` {r}
CaliLarvalData$Mass.adult <- as.numeric(CaliLarvalData$Mass.adult)

```

# 1. Fill unfilled columns at survival for each stage

## Surv.4th
```{r}
for (i in 1:length(CaliLarvalData$Surv.4th)){
  if(is.na(CaliLarvalData[i,7])== TRUE){
    CaliLarvalData[i,5] <- "N"
  } else if(is.na(CaliLarvalData[i,7])== FALSE){
    CaliLarvalData[i,5] <- "Y"
  }
}
```

## Surv.5th
```{r}
for (i in 1:length(CaliLarvalData$Surv.5th)){
  if(is.na(CaliLarvalData[i,11])== TRUE){
    CaliLarvalData[i,9] <- "N"
  } else if(is.na(CaliLarvalData[i,11])== FALSE){
    CaliLarvalData[i,9] <- "Y"
  }
}
```

## Surv.pupa
```{r}
for (i in 1:length(CaliLarvalData$Surv.pupa)){
  if(is.na(CaliLarvalData[i,15])== TRUE){
    CaliLarvalData[i,13] <- "N"
  } else if(is.na(CaliLarvalData[i,15])== FALSE){
    CaliLarvalData[i,13] <- "Y"
  }
}
```

## Surv.eclose
```{r}
for (i in 1:length(CaliLarvalData$Surv.eclose)){
  if(is.na(CaliLarvalData[i,20])== TRUE){
    CaliLarvalData[i,18] <- "N"
  } else if(is.na(CaliLarvalData[i,20])== FALSE){
    CaliLarvalData[i,18] <- "Y"
  }
}
```

# 2. Work on getting summary data table

## Add in rates for pupation and eclosion

```{r}
CaliLarvalData$pupal.devrate <- 1/(CaliLarvalData$Time.pupa)

CaliLarvalData$eclose.devrate <-1/(CaliLarvalData$Time.eclose)
```

## For individuals that survived to eclosion

```{r}
eclosioncleaned <- CaliLarvalData[CaliLarvalData$CID != 5, ]
eclosioncleaned <- eclosioncleaned[eclosioncleaned$CID != 56, ]
eclosioncleaned <- eclosioncleaned[eclosioncleaned$CID != 109, ]
eclosioncleaned <- eclosioncleaned[eclosioncleaned$CID != 224, ]
eclosioncleaned[124,23] = ""
eclosioncleaned[274,23] = "yes"
```

### Mass of pupa
```{r}
pupalmass <- summarySE(data = eclosioncleaned[eclosioncleaned$Surv.eclose == "Y", ], measurevar = "Mass.pupa", groupvars = c("Mean.temp"))

pupalmass

pupalmass$Mass.se <- pupalmass$se

pupalmass <- pupalmass %>%
  select(Mean.temp, N, Mass.pupa, Mass.se)

```

### Mass of adults separated by eclose.ok
```{r}
Successfuladultmass <- summarySE(data = eclosioncleaned[eclosioncleaned$Surv.eclose == "Y", ], measurevar = "Mass.adult", groupvars = c("Mean.temp", "Eclose.ok"))

Successfuladultmass

Successfuladultmass$Adultmass.se <- Successfuladultmass$se

Successfuladultmass <- Successfuladultmass %>%
  select(Mean.temp, Eclose.ok, N, Mass.adult, Adultmass.se)

```

### Mass of adults not separated by eclose.ok
```{r}
adultmass <- summarySE(data = eclosioncleaned[eclosioncleaned$Surv.eclose == "Y", ], measurevar = "Mass.adult", groupvars = c("Mean.temp"))

adultmass

adultmass$Adultmass.se <- adultmass$se

adultmass <- adultmass %>%
  select(Mean.temp, N, Mass.adult, Adultmass.se)

adultmass

```


### Mean time to pupation and SE
```{r}
pupaltime <- summarySE(data = eclosioncleaned[eclosioncleaned$Surv.eclose == "Y", ], measurevar = "Time.pupa", groupvars = c("Mean.temp"))

pupaltime

pupaltime$Time.se <- pupaltime$se

pupaltime <- pupaltime %>%
  select(Mean.temp, N, Time.pupa, Time.se)

```

### Mean time to eclosion and SE
```{r}
adulttime <- summarySE(data = eclosioncleaned[eclosioncleaned$Surv.eclose == "Y", ], measurevar = "Time.eclose", groupvars = c("Mean.temp"))

adulttime

adulttime$AdultTime.se <- adulttime$se

adulttime <- adulttime %>%
  select(Mean.temp, N, Time.eclose, AdultTime.se)

```

### Pupal dev rates 
```{r}
pupaldevrate <- summarySE(data = eclosioncleaned[eclosioncleaned$Surv.eclose == "Y", ], measurevar = "pupal.devrate", groupvars = c("Mean.temp"))

pupaldevrate

pupaldevrate$PDevRate.se <- pupaldevrate$se

pupaldevrate <- pupaldevrate %>%
  select(Mean.temp, N, pupal.devrate, PDevRate.se)

```

### Adult dev rates 
```{r}
adultdevrate <- summarySE(data = eclosioncleaned[eclosioncleaned$Surv.eclose == "Y", ], measurevar = "eclose.devrate", groupvars = c("Mean.temp"))

adultdevrate

adultdevrate$ADevRate.se <- adultdevrate$se

adultdevrate <- adultdevrate %>%
  select(Mean.temp, N, eclose.devrate, ADevRate.se)

```

### Merge together

```{r}
pdata<- merge(pupalmass, pupaltime, by = c("Mean.temp", "N"))
pdata <- merge(pdata, pupaldevrate, by = c("Mean.temp", "N"))

adata<- merge(adultmass, adulttime, by = c("Mean.temp", "N"))
adata <- merge(adata, adultdevrate, by = c("Mean.temp", "N"))

DataSummary <-merge(adata, pdata, by = c("Mean.temp", "N"))

DataSummary$Mean.temp <- as.factor(DataSummary$Mean.temp)
DataSummary
```
#4. Graphing!!!

## Pupal Mass v. Time to Pupation

```{r}
pupalgraph <- ggplot(data = DataSummary, aes(x = Time.pupa, y = Mass.pupa, color = Mean.temp)) + 
  theme_bw() + 
  geom_point(size = 3) + 
  geom_errorbar(aes(ymin = Mass.pupa - Mass.se, ymax = Mass.pupa + Mass.se)) + 
  geom_errorbarh(aes(xmin = Time.pupa - Time.se, xmax = Time.pupa + Time.se)) + 
  guides(scale = "none") + 
  scale_color_manual(values = c("purple", "#1E88E5", "lime green", "orange", "#D81B60")) + 
  labs(x = "Time until pupation (days)", y = "Mass at pupation (mg)", color = "Mean temperature treatment")
pupalgraph

```

```{r}
devrategraph <- ggplot(data = DataSummary, aes(x = Mean.temp, y = eclose.devrate)) + 
  theme_bw() + 
  geom_point(size = 3) + 
  geom_errorbar(aes(ymin = eclose.devrate - ADevRate.se, ymax = eclose.devrate + ADevRate.se), width = 0.3) + 
  geom_line() + 
  labs(x = "Mean Rearing Temperature", y = "Development Rate")

devrategraph
```
