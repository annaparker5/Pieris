---
title: "PopulationComparisonsCA"
output: html_document
date: "2023-08-15"
---

## 0. Load packages and data

```{r}
library(dplyr)
library(lubridate)
```


```{r}
NC1 <- read.csv("~/Desktop/GitHub/Pieris/North_Carolina/NC_Larval_and_Realistic_Temps/Data/CleanedRound1.csv", header = T)
NC2 <- read.csv("~/Desktop/GitHub/Pieris/NCLarval2023.csv", header= T)
WA1 <- read.csv("~/Desktop/GitHub/Pieris/Washington/DataWA/CleanedBlock1.csv", header = T)
WA1wide <- read.csv("~/Desktop/GitHub/Pieris/Washington/DataWA/WABlock1Dev.csv", header = T)
WA2 <- read.csv("~/Desktop/GitHub/Pieris/Washington/DataWA/CleanedBlock2.csv", header = T)
WA2wide <- read.csv("~/Desktop/GitHub/Pieris/Washington/DataWA/WABlock2Dev.csv", header = T)
CA <- read.csv("~/Desktop/GitHub/Pieris/California/CALarval/CAPierisLarvalData.csv", header = T)
```

## Converting Mass.adult column from character to numeric
``` {r}
CA$Mass.adult <- as.numeric(CA$Mass.adult)

```

 Fill unfilled columns at survival for each stage

## Surv.4th
```{r}
for (i in 1:length(CA$Surv.4th)){
  if(is.na(CA[i,7])== TRUE){
    CA[i,5] <- "N"
  } else if(is.na(CA[i,7])== FALSE){
    CA[i,5] <- "Y"
  }
}
```

## Surv.5th
```{r}
for (i in 1:length(CA$Surv.5th)){
  if(is.na(CA[i,11])== TRUE){
    CA[i,9] <- "N"
  } else if(is.na(CA[i,11])== FALSE){
    CA[i,9] <- "Y"
  }
}
```

## Surv.pupa
```{r}
for (i in 1:length(CA$Surv.pupa)){
  if(is.na(CA[i,15])== TRUE){
    CA[i,13] <- "N"
  } else if(is.na(CA[i,15])== FALSE){
    CA[i,13] <- "Y"
  }
}
```

## Surv.adult
```{r}
for (i in 1:length(CA$Surv.adult)){
  if(is.na(CA[i,20])== TRUE){
    CA[i,18] <- "N"
  } else if(is.na(CA[i,20])== FALSE){
    CA[i,18] <- "Y"
  }
}
```

first I need to make sure that all intermediates are labeled as dead on the day they failed to pupate
```{r}
for (i in 1:length(CA$Date.dead)) {
  if  (CA[i, 17] == "no"){
    CA[i, 24] = CA[i,15]}
}
```

Next lets add the prepupual death column

```{r}
CA$Time.prepupal.death <- NA
```

```{r}
for(i in 1:length(CA$Time.prepupal.death)) { 
  if (CA[i, 17] == "yes"){
    CA[i, 27] <- NA
  } else if (CA[i, 17] != "yes"){
    CA[i, 27] <- CA[i, 25]
  }
}
```


Also, lets change all "yes" and "no" to "Y" and "N" for consistency 

```{r}
CA <- data.frame(lapply(CA, function(x) {
          gsub("no", "N", x)
}))

CA <- data.frame(lapply(CA, function(x) {
          gsub("yes", "Y", x)
}))

```



NC pop round 1

```{r}
NC1$Time.prepupal.death <- NA
```

```{r}
for(i in 1:length(NC1$Time.prepupal.death)) { 
  if (NC1[i, 19] == "Y"){
    NC1[i, 30] <- NA
  } else if (NC1[i, 19] != "Y"){
    NC1[i, 30] <- NC1[i, 27]
  }
}
```

NC pop round 2

Fill unfilled columns at survival for each stage

## Surv.4th
```{r}
for (i in 1:length(NC2$Surv.4th)){
  if(is.na(NC2[i,9])== TRUE){
    NC2[i,7] <- "N"
  } else if(is.na(NC2[i,9])== FALSE){
    NC2[i,7] <- "Y"
  }
}
```

## Surv.5th
```{r}
for (i in 1:length(NC2$Surv.5th)){
  if(is.na(NC2[i,13])== TRUE){
    NC2[i,11] <- "N"
  } else if(is.na(NC2[i,13])== FALSE){
    NC2[i,11] <- "Y"
  }
}
```

## Surv.pupa
```{r}
for (i in 1:length(NC2$Surv.pupa)){
  if(is.na(NC2[i,17])== TRUE){
    NC2[i,15] <- "N"
  } else if(is.na(NC2[i,17])== FALSE){
    NC2[i,15] <- "Y"
  }
}
```

## Surv.eclose
```{r}
for (i in 1:length(NC2$Surv.eclose)){
  if(is.na(NC2[i,22])== TRUE){
    NC2[i,20] <- "N"
  } else if(is.na(NC2[i,22])== FALSE){
    NC2[i,20] <- "Y"
  }
}
```

first I need to make sure that all intermediates are labeled as dead on the day they failed to pupate
```{r}
for (i in 1:length(NC2$Date.dead)) {
  if  (NC2[i, 19] == "N"){
    NC2[i, 26] = NC2[i,16]}
}
```

Next lets add the prepupual death column

```{r}
NC2$Time.prepupal.death <- NA
```

```{r}
for(i in 1:length(NC2$Time.prepupal.death)) { 
  if (NC2[i, 19] == "Y"){
    NC2[i, 29] <- NA
  } else if (NC2[i, 19] != "yes"){
    NC2[i, 29] <- NC2[i, 27]
  }
}
```




Washington pops:


```{r}
# Internal process of the loop to convert days to dates
expt_day <- function(start.date, date){
  date <- mdy(date)
  start <- mdy(start.date)
  diff <- yday(date) - yday(start)

  return(diff)
}

# Code for the loop itself
loop <- function(start.date, date.list){
  days <- rep(NA, length(date.list))
  for (i in 1:(length(days))){
    days[i] <- expt_day(start.date = start.date, date = date.list[i])
  }
  return(days)
}
```


We need to combine all of these different "death" conditions and select only the ones that died prior to pupation. Let's write a giant for loop, so that we don't have to do it by hand in Excel. 

```{r}
WA1wide$Prepupal.death <- NA

WA1wide[22, 15] <- 150
```


```{r}
for (i in 1:length(WA1wide$Prepupal.death)){
  if (is.na(WA1wide[i, 15]) == FALSE){
    WA1wide[i, 26] <- NA
  } else if (is.na(WA1wide[i, 15]) == TRUE){
    if (is.na(WA1wide[i, 17]) == FALSE) {
      WA1wide[i, 26] <- WA1wide[i, 16]
    } else if (is.na(WA1wide[i, 17]) == TRUE) {
      WA1wide[i, 26] <- WA1wide[i, 21]
    }
  
  }
  
}  
```




```{r}
WA1wide$day.hatch <- loop(start.date = "11/16/2022", date.list = WA1wide$Date.hatch)
WA1wide$Prepupal.death.day <- loop(start.date = "11/16/2022", date.list = WA1wide$Prepupal.death)
```

**Above code is busted if it crosses the year mark. Gotta add 365 to the negative numbers**

```{r}
for (i in 1:length(WA1wide$Prepupal.death.day)){
  if (is.na(WA1wide[i, 28]) == FALSE){
      if (WA1wide[i, 28] < 0) {
      WA1wide[i, 28] <- WA1wide[i, 28] + 365
    } else if (WA1wide[i, 28] >= 0) {
     WA1wide[i, 28] <- WA1wide[i, 28]
    }
  } else if (is.na(WA1wide[i, 28]) == TRUE){
    WA1wide[i, 28] <- NA
  }

}
```



```{r}
WA1wide$Age.prepupal.death <- WA1wide$Prepupal.death.day - WA1wide$day.hatch
```

**REPEAT FOR WA2**

```{r}
WA2wide$Prepupal.death <- NA

WA2wide[55, 14] <- 150
```


```{r}
for (i in 1:length(WA2wide$Prepupal.death)){
  if (is.na(WA2wide[i, 14]) == FALSE){
    WA2wide[i, 25] <- NA
  } else if (is.na(WA2wide[i, 14]) == TRUE){
    if (is.na(WA2wide[i, 16]) == FALSE) {
      WA2wide[i, 25] <- WA2wide[i, 15]
    } else if (is.na(WA2wide[i, 16]) == TRUE) {
      WA2wide[i, 25] <- WA2wide[i, 20]
    }
  
  }
  
}  
```


```{r}
WA2wide$day.hatch <- loop(start.date = "11/30/2022", date.list = WA2wide$Date.hatch)
WA2wide$Prepupal.death.day <- loop(start.date = "11/30/2022", date.list = WA2wide$Prepupal.death)
```

**Above code is busted if it crosses the year mark. Gotta add 365 to the negative numbers**

```{r}
for (i in 1:length(WA2wide$Prepupal.death.day)){
  if (is.na(WA2wide[i, 27]) == FALSE){
      if (WA2wide[i, 27] < 0) {
      WA2wide[i, 27] <- WA2wide[i, 27] + 365
    } else if (WA2wide[i, 27] >= 0) {
     WA2wide[i, 27] <- WA2wide[i, 27]
    }
  } else if (is.na(WA2wide[i, 27]) == TRUE){
    WA2wide[i, 27] <- NA
  }

}
```


```{r}
WA2wide$Age.prepupal.death <- WA2wide$Prepupal.death.day - WA2wide$day.hatch
```


## 2. Select the relevant columns


```{r}
CASum <- CA %>%
  select(CID = CID, Treatment = Mean.temp, Age.death = Time.prepupal.death, Surv.pupa, PupateOK = Pupate.ok, 
         Age.pupa = Time.pupa, Mass.pupa = Mass.pupa)

CASum$Expt <- "CA"
CASum$Population <- "CA"
```


```{r}
NC1Sum <- NC1 %>%
  select(CID = CID, Treatment = Mean.Temp, Age.death = Time.prepupal.death, Surv.pupa, PupateOK = PupateOk, 
         Age.pupa = Time.pupa, Mass.pupa = Mass.pupa)

NC1Sum$Expt <- "NC1"
NC1Sum$Population <- "NC"
```


```{r}
NC2Sum <- NC2 %>%
  select(CID = CID, Treatment = Mean.temp, Age.death = Time.prepupal.death, Surv.pupa, PupateOK = Pupate.ok, 
         Age.pupa = Time.pupa, Mass.pupa = Mass.pupa)

NC2Sum$Expt <- "NC2"
NC2Sum$Population <- "NC"
```

```{r}
WA1wide <- WA1wide %>%
  select(CID = CID, Treatment = Treatment, Age.death = Age.prepupal.death, Mass.pupa = Mass.pupa)

WA1Sum <- WA1 %>%
  select(CID = CID, Treatment = Treatment, Surv.pupa, PupateOK, Age.pupa = DaysHtoP)

WA1merge <- merge(WA1wide, WA1Sum, by = c("CID", "Treatment"))

WA1merge$Expt <- "WA1"
WA1merge$Population <- "WA"
```


```{r}
WA2wide <- WA2wide %>%
  select(CID = CID, Treatment = Treatment, Age.death = Age.prepupal.death, Mass.pupa = Mass.pupa)

WA2Sum <- WA2 %>%
  select(CID = CID, Treatment = Treatment, Surv.pupa, PupateOK, Age.pupa = DaysHtoP)

WA2merge <- merge(WA2wide, WA2Sum, by = c("CID", "Treatment"))

WA2merge$Expt <- "WA2"
WA2merge$Population <- "WA"
```

## 3. Combine and output

```{r}
output <- rbind(NC1Sum, NC2Sum)

output <-rbind(output, WA1merge)

output <- rbind(output, WA2merge)

output <- rbind(output, CASum)

```


```{r}
write.csv(output, file = "~/Desktop/GitHub/Pieris/PopulationCombData.csv")
```

##4. Survival Analysis

```{r}
population <- c("North Carolina", "Washington", "California")

NCT <- length(NC1$CID) + length(NC2$CID)
WAT <- length(WA1$CID) + length(WA2$CID)
Total <- c(NCT, WAT, length(CA$CID))



CombSurv <- data.frame(population, Total)
```





##5. Random Analysis

```{r}
mod1<- lm(Age.pupa ~ Treatment * Population, data= output)

summary(mod1)
anova(mod1)
```


