---
title: "Curve Fitting"
output: html_notebook
---

Here, we will fit the dev rate curves with rTPC. Then, we will make a function to pull from rTPC curves to compare to the April and August data. 

Roadmap: 

0. Install packages and load in data
1. Redo data manipulation
2. Fit dev rate curve to only successful pupations hourly
3. Fit dev rate curve to all larval-pupal intermediates and successful pupations hourly
4. Fit dev rate curve to all larval-pupal intermediates and successful pupations daily


#0. Load in packages and data

```{r}
library(remotes)
#remotes::install_github("padpadpadpad/rTPC")
library(rTPC)
library(nls.multstart)
library(Rmisc)
library(tidyverse)
library(broom)
library(purrr)
library(ggplot2)
```

```{r}
data <- read.csv("~/Desktop/Github/Pieris/Data/CleanedRound1.csv", header = TRUE)

data$Mean.Temp <- as.factor(data$Mean.Temp)
```

# 1. Redo data analysis 

## Pupal mass

Separating out LPI and successful pupae 

### Mean mass and SE

```{r}
pupalmeans <- summarySE(data = data[data$Surv.pupa == "Y", ], measurevar = "Mass.pupa", groupvars = c("Mean.Temp", "PupateOk"))

pupalmeans

pupalmeans$Mass.se <- pupalmeans$se

pupalmeans <- pupalmeans %>%
  select(Mean.Temp, PupateOk, N, Mass.pupa, Mass.se)


```

### Mean dev time and SE

```{r}
pupaltimemeans <- summarySE(data = data[data$Surv.pupa == "Y", ], measurevar = "Time.pupa", groupvars = c("Mean.Temp", "PupateOk"))

pupaltimemeans

pupaltimemeans$Time.se <- pupaltimemeans$se

pupaltimemeans <- pupaltimemeans %>%
  select(Mean.Temp, PupateOk, N, Time.pupa, Time.se)
```

### Merge together

```{r}
pupalmeans <- merge(pupalmeans, pupaltimemeans, by = c("Mean.Temp", "PupateOk", "N"))
```


## Add in development rate

```{r}
data$Dev.Rate <- 1 / (data$Time.pupa)
```

```{r}
pupalratemeans <- summarySE(data = data[data$Surv.pupa == "Y", ], measurevar = "Dev.Rate", groupvars = c("Mean.Temp", "PupateOk"))

pupalratemeans

pupalratemeans$Rate.se <- pupalratemeans$se

pupalratemeans <- pupalratemeans %>%
  select(Mean.Temp, PupateOk, N, Dev.Rate, Rate.se)
```


```{r}
pupalmeans <- merge(pupalmeans, pupalratemeans, by = c("Mean.Temp", "PupateOk", "N"))
```

## Pupal means combined with LPI and pupa


```{r}
pupalmeanstotal <- summarySE(data = data[data$Surv.pupa == "Y", ], measurevar = "Mass.pupa", groupvars = c("Mean.Temp"))

pupalmeanstotal

pupalmeanstotal$Mass.se <- pupalmeanstotal$se

pupalmeanstotal <- pupalmeanstotal %>%
  select(Mean.Temp, N, Mass.pupa, Mass.se)


```

### Mean dev time and SE

```{r}
pupaltimemeanstotal <- summarySE(data = data[data$Surv.pupa == "Y", ], measurevar = "Time.pupa", groupvars = c("Mean.Temp"))

pupaltimemeanstotal

pupaltimemeanstotal$Time.se <- pupaltimemeanstotal$se

pupaltimemeanstotal <- pupaltimemeanstotal %>%
  select(Mean.Temp, N, Time.pupa, Time.se)
```

### Merge together

```{r}
pupalmeanstotal <- merge(pupalmeanstotal, pupaltimemeanstotal, by = c("Mean.Temp", "N"))
```


## Add in development rate

```{r}
pupalratemeanstotal <- summarySE(data = data[data$Surv.pupa == "Y", ], measurevar = "Dev.Rate", groupvars = c("Mean.Temp"))

pupalratemeanstotal

pupalratemeanstotal$Rate.se <- pupalratemeanstotal$se

pupalratemeanstotal <- pupalratemeanstotal %>%
  select(Mean.Temp, N, Dev.Rate, Rate.se)
```


```{r}
pupalmeanstotal <- merge(pupalmeanstotal, pupalratemeanstotal, by = c("Mean.Temp", "N"))
```



## Survival to pupation vs temp treatment 

1. Create summary table
2. Create blank table for input
3. Hard code input
4. Graph it

### 1. Create summary table

```{r}
survpercsum <- summarySE(data = data, 
                         measurevar = "Mass.pupa", 
                         groupvars = c("Mean.Temp", "Surv.pupa"))
```

### 2. Create blank table

```{r}
survdata <- data.frame(Mean.Temp = c(16, 21, 26, 30, 34), 
                       surv.perc = 0, 
                       group = 1)

survdata$Mean.Temp <- as.factor(survdata$Mean.Temp)
survdata$group = as.factor(survdata$group)
```

### 3. Hard code it

```{r}
survdata[1, 2] <- survpercsum[2, 3] / (survpercsum[2, 3] + survpercsum[1, 3])
survdata[2, 2] <- survpercsum[4, 3] / (survpercsum[4, 3] + survpercsum[3, 3])
survdata[3, 2] <- survpercsum[6, 3] / (survpercsum[6, 3] + survpercsum[5, 3])
survdata[4, 2] <- survpercsum[8, 3] / (survpercsum[8, 3] + survpercsum[7, 3])
survdata[5, 2] <- survpercsum[10, 3] / (survpercsum[10, 3] + survpercsum[9, 3])
```

# 2. Fit dev rate curve just for successful pupa using rTPC


Change temp to not be a factor
```{r}
pupalmeans$Mean.Temp <- as.character(pupalmeans$Mean.Temp)
pupalmeans$Mean.Temp <- as.numeric(pupalmeans$Mean.Temp)

pupalmeansyes <- pupalmeans[pupalmeans$PupateOk == "Y", ]
```


Our object is called `r pupalmeans`. 

```{r}
fitmodgauss <- nls_multstart(data = pupalmeansyes[, c(1, 8)], 
                             Dev.Rate ~ modifiedgaussian_2006(temp = Mean.Temp, rmax, topt, a, b), 
                             iter = c(5, 5, 5, 5), 
                             start_lower = get_start_vals(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") - 10,
                             start_upper = get_start_vals(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate,
                                                          model_name = "modifiedgaussian_2006") + 10, 
                             lower = get_lower_lims(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate,
                                                    model_name = "modifiedgaussian_2006"), 
                             upper = get_upper_lims(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate,
                                                    model_name = "modifiedgaussian_2006")) 
```

```{r}
summary(fitmodgauss)
```

## Modifying Lauren Buckley's code


```{r}
d <- as.data.frame(cbind(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate))

colnames(d) <- c("temp", "rate")
```


```{r}
d_fits <- nest(d, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
d_stack <- select(d_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
params <- d_stack %>%
  mutate(., est = map(fit, tidy)) %>%
  select(-fit) %>%
  unnest(est)

# get predictions using augment
newdata <- tibble(temp = seq(min(d$temp), max(d$temp), length.out = 100))
d_preds <- d_stack %>%
  mutate(., preds = map(fit, augment, newdata = newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
ggplot(d_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), d) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

```

## Compare models using AIC

```{r}
AIC(d_fits[[2]][[1]],d_fits[[3]][[1]], d_fits[[4]][[1]], d_fits[[5]][[1]])
```

Modified gaussian is the best. Now let's predict to the x-axis and graph that. 


```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

d_preds_two <- d_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
ggplot(d_preds_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), d) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)
```



```{r}
modelcomp <- ggplot(d_preds_two[c(1:200, 601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), d) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

modelcomp

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/fittedmodelcomp.png", modelcomp, width = 8, height = 5)
```

```{r}
modelcomp2 <- ggplot(d_preds_two[c(1:200, 601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), d, color = "black") +
  geom_line(aes(temp, .fitted, color = model_name)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Model fit comparison', 
       color = "Model name") +
  geom_hline(aes(yintercept = 0), linetype = 2) + 
  scale_color_manual(values = c("purple", "lime green"))

modelcomp2

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/fittedmodelcomp2.png", modelcomp2, width = 8, height = 5)
```

## Graphing just the weibull curve
```{r}
modweibull <-ggplot(d_preds_two[c(601:800), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), d, color = "black") +
  geom_line(aes(temp, .fitted)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Weibull Model For Development Rate') +
  geom_hline(aes(yintercept = 0), linetype = 2) + 
  scale_color_manual(values = c("purple"))

modweibull

```
```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/modweibull.png", modweibull, width = 8, height = 5)
```

## Getting the final dev rate curve 

```{r}

fitmodweibull <- nls_multstart(data = pupalmeansyes[, c(1, 8)], 
                             Dev.Rate ~ weibull_1995(temp = Mean.Temp, a, topt, b, c), 
                             iter = c(4, 4, 4, 4), 
                             start_lower = get_start_vals(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate,
                                                          model_name = "weibull_1995") - 10,
                             start_upper = get_start_vals(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate,
                                                          model_name = "weibull_1995") + 10, 
                             lower = get_lower_lims(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate,
                                                    model_name = "weibull_1995"), 
                             upper = get_upper_lims(pupalmeansyes$Mean.Temp, pupalmeansyes$Dev.Rate,
                                                    model_name = "weibull_1995"), 
                             supp_errors = 'Y',
                             convergence_count = FALSE) 

```

```{r}
summary(fitmodweibull)
```

## Load in our April and August temp data 

```{r}
april <- read.csv("~/Desktop/GitHub/Pieris/Data/simulated_36_-79_2_d_2022_4_1_5_31_inbetween.csv", header = TRUE)

august <- read.csv("~/Desktop/GitHub/Pieris/Data/simulated_36_-79_2_d_2022_8_1_8_31_inbetween.csv", header = TRUE)
```

## Create our output datafile

### Cut down by hour

```{r}
aprilhourly <- april[april$V7 == 0, ]
augusthourly <- august[august$V7 == 0, ]
```

```{r}
apriltemps <- tibble(Mean.Temp = aprilhourly$V1) ## Needs to be the same column name as in the model object

augusttemps <- tibble(Mean.Temp = augusthourly$V1)
```


## TANGENT: Graph temp distributions compared to weibull curve 

```{r}
histtemps <- tibble(Mean.Temp = seq((-5), 50, length.out = 200))

solopreds <- augment(fitmodweibull, newdata = histtemps)
```

```{r}
weibullwithhist <-ggplot(data = solopreds) +
  geom_line(aes(x = Mean.Temp, y = .fitted), color = "gray") +
  geom_point(aes(x = Mean.Temp,y = Dev.Rate), data = pupalmeansyes, color = "black") +
  theme_bw() +
  labs(x = 'Temperature (ºC)') +
  scale_y_continuous(name = "Development Rate", 
                     sec.axis = sec_axis(trans = ~., name = "Counts of observed temperatures")) + 
  geom_histogram(data = apriltemps, aes(x = Mean.Temp, y = ..count.. / 5000), color = "lime green", 
                 fill = "lime green", alpha = .5) + 
  geom_histogram(data = augusttemps, aes(x = Mean.Temp, y = ..count.. / 5000), color = "turquoise", 
                 fill = "turquoise", alpha = .5) + 


weibullwithhist


```


## Get predictions into that datafile

```{r}
aprilpreds <- augment(fitmodweibull, newdata = apriltemps)

augustpreds <- augment(fitmodweibull, newdata = augusttemps)


aprilpreds$.fitted <- aprilpreds$.fitted / 24

augustpreds$.fitted <- augustpreds$.fitted / 24

```

## Add dev rate until we hit 1, then extract total number of hours 

```{r}
apriloutput <- data.frame(hour = 1, .fitted = aprilpreds[1, 2])

for(i in 1:length(aprilpreds$.fitted)){
  if(apriloutput[i, 2] >= 1){
    print(apriloutput[i, 1] / 24)
  } else if(apriloutput[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (apriloutput[i, 2] + aprilpreds[i+1, 2]))
    apriloutput <- rbind(apriloutput, newoutput)
  }
}
```

```{r}
augustoutput <- data.frame(hour = 1, .fitted = augustpreds[1, 2])

for(i in 1:length(augustpreds$.fitted)){
  if(augustoutput[i, 2] >= 1){
    print(augustoutput[i, 1] / 24)
  } else if(augustoutput[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (augustoutput[i, 2] + augustpreds[i+1, 2]))
    augustoutput <- rbind(augustoutput, newoutput)
  }
}
```


# 3. Fitting the dev rate curve with all SurvPupa = Y individuals using rTPC

```{r}
pupalmeanstotal$Mean.Temp <- as.character(pupalmeanstotal$Mean.Temp)
pupalmeanstotal$Mean.Temp <- as.numeric(pupalmeanstotal$Mean.Temp)
```


```{r}
dtotal <- as.data.frame(cbind(pupalmeanstotal$Mean.Temp, pupalmeanstotal$Dev.Rate))

colnames(dtotal) <- c("temp", "rate")
```


```{r}
d_fits_total <- nest(dtotal, data = c(temp, rate)) %>%
  mutate(modified_gaussian = map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                         data = .x,
                                         iter = c(4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'modifiedgaussian_2006') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         rezende = map(data, ~nls_multstart(rate~rezende_2019(temp = temp, q10, a, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'rezende_2019') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'rezende_2019'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref=29),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         weibull = map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a,topt,b,c),
                                            data = .x,
                                            iter = c(4,4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'weibull_1995') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)))

# stack models
d_stack_total <- select(d_fits_total, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', modified_gaussian:weibull)

# get parameters using tidy (no longer working)
#params <- d_stack %>%
 # mutate(., est = map(fit, tidy)) %>%
  #select(-fit) %>%
  #unnest(est)

# get predictions using augment
newdatatotal <- tibble(temp = seq(min(dtotal$temp), max(dtotal$temp), length.out = 100))

d_preds_total <- d_stack_total %>%
  mutate(., preds = map(fit, augment, newdata = newdatatotal)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
# plot fits
ggplot(d_preds_total, aes(temp, rate)) +
  geom_point(aes(temp, rate), dtotal) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)

```

### Compare using AIC




```{r}
AIC(d_fits_total[[2]][[1]],d_fits_total[[3]][[1]], d_fits_total[[4]][[1]], d_fits_total[[5]][[1]])
```


```{r}
toxaxis <- tibble(temp = seq((-5), 50, length.out = 200))

d_preds_total_two <- d_stack_total %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis)) %>%
  select(-fit) %>%
  unnest(preds)
```

```{r}
ggplot(d_preds_total_two, aes(temp, rate)) +
  geom_point(aes(temp, rate), dtotal) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Development rate',
       title = 'Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)
```

### Fitting the weibull model


```{r}

fitmodweibulltotal <- nls_multstart(data = pupalmeanstotal[, c(1, 7)], 
                             Dev.Rate ~ weibull_1995(temp = Mean.Temp, a, topt, b, c), 
                             iter = c(4, 4, 4, 4), 
                             start_lower = get_start_vals(pupalmeanstotal$Mean.Temp, pupalmeanstotal$Dev.Rate,
                                                          model_name = "weibull_1995") - 10,
                             start_upper = get_start_vals(pupalmeanstotal$Mean.Temp, pupalmeanstotal$Dev.Rate,
                                                          model_name = "weibull_1995") + 10, 
                             lower = get_lower_lims(pupalmeanstotal$Mean.Temp, pupalmeanstotal$Dev.Rate,
                                                    model_name = "weibull_1995"), 
                             upper = get_upper_lims(pupalmeanstotal$Mean.Temp, pupalmeanstotal$Dev.Rate,
                                                    model_name = "weibull_1995"), 
                             supp_errors = 'Y',
                             convergence_count = FALSE) 

```

```{r}
summary(fitmodweibulltotal)
```

## Get predictions into that datafile - hourly

```{r}
aprilpredstotal <- augment(fitmodweibulltotal, newdata = apriltemps)

augustpredstotal <- augment(fitmodweibulltotal, newdata = augusttemps)


aprilpredstotal$.fitted <- aprilpredstotal$.fitted / 24

augustpredstotal$.fitted <- augustpredstotal$.fitted / 24

```

## Add dev rate until we hit 1, then extract total number of hours 

```{r}
apriloutputtotal <- data.frame(hour = 1, .fitted = aprilpredstotal[1, 2])

for(i in 1:length(aprilpredstotal$.fitted)){
  if(apriloutputtotal[i, 2] >= 1){
    print(apriloutputtotal[i, 1] / 24)
  } else if(apriloutputtotal[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (apriloutputtotal[i, 2] + aprilpredstotal[i+1, 2]))
    apriloutputtotal <- rbind(apriloutputtotal, newoutput)
  }
}
```

```{r}
augustoutputtotal <- data.frame(hour = 1, .fitted = augustpredstotal[1, 2])

for(i in 1:length(augustpredstotal$.fitted)){
  if(augustoutputtotal[i, 2] >= 1){
    print(augustoutputtotal[i, 1] / 24)
  } else if(augustoutputtotal[i, 2] < 1){
    newoutput <- data.frame(hour = i+1, .fitted = (augustoutputtotal[i, 2] + augustpredstotal[i+1, 2]))
    augustoutputtotal <- rbind(augustoutputtotal, newoutput)
  }
}
```


# 4. Fit all to daily temp means

```{r}
aprdailymeans <- data.frame(Mean.Temp = 0)

april$V10 <- april$V8 + 1
```

### Get daily mean temperatures

```{r}
for(i in 1:length(unique(april$V10))){
  subset <- april[april$V10 == i, ]
  meanval <- mean(subset$V1)
  aprdailymeans <- rbind(aprdailymeans, meanval)
}
```

```{r}
aprdailymeans <- aprdailymeans[2:62, ]

aprdailymeans <- tibble(Mean.Temp = aprdailymeans)
```

## Do the prediction part

```{r}
aprildailypreds <- augment(fitmodweibulltotal, newdata = aprdailymeans)
```

## Add dev rate until we hit 1, then extract total number of days

```{r}
aprildailyoutput <- data.frame(day = 1, .fitted = aprildailypreds[1, 2])

for(i in 1:length(aprildailypreds$.fitted)){
  if(aprildailyoutput[i, 2] >= 1){
    print(aprildailyoutput[i, 1])
  } else if(aprildailyoutput[i, 2] < 1){
    newoutput <- data.frame(day = i+1, .fitted = (aprildailyoutput[i, 2] + aprildailypreds[i+1, 2]))
    aprildailyoutput <- rbind(aprildailyoutput, newoutput)
  }
}
```

Much slower

## AUGUST


```{r}
augdailymeans <- data.frame(Mean.Temp = 0)

august$V10 <- august$V8 + 1
```

```{r}
for(i in 1:length(unique(august$V10))){
  subset <- august[august$V10 == i, ]
  #print(subset)
  meanval <- mean(subset$V1)
  augdailymeans <- rbind(augdailymeans, meanval)
}
```

```{r}
augdailymeans <- augdailymeans[2:32, ]

augdailymeans <- tibble(Mean.Temp = augdailymeans)
```

## Do the prediction part

```{r}
augustdailypreds <- augment(fitmodweibulltotal, newdata = augdailymeans)
```

## Add dev rate until we hit 1, then extract total number of days

```{r}
augustdailyoutput <- data.frame(day = 1, .fitted = augustdailypreds[1, 2])

for(i in 1:length(augustdailypreds$.fitted)){
  if(augustdailyoutput[i, 2] >= 1){
    print(augustdailyoutput[i, 1])
  } else if(augustdailyoutput[i, 2] < 1){
    newoutput <- data.frame(day = i+1, .fitted = (augustdailyoutput[i, 2] + augustdailypreds[i+1, 2]))
    augustdailyoutput <- rbind(augustdailyoutput, newoutput)
  }
}
```

Right on the money this time



# 3. Survival curves

```{r}
survdata$Mean.Temp <- as.character(survdata$Mean.Temp)
survdata$Mean.Temp <- as.numeric(survdata$Mean.Temp)
```


```{r}
s <- as.data.frame(cbind(survdata$Mean.Temp, survdata$surv.perc))

colnames(s) <- c("temp", "rate")
```


```{r}
s_fits <- nest(s, data = c(temp, rate)) %>%
  mutate(beta = map(data, ~nls_multstart(rate~beta_2012(temp = temp, a, b, c, d, e),
                                         data = .x,
                                         iter = c(4,4,4,4,4),
                                         start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'beta_2012') - 10,
                                         start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                      model_name = 'beta_2012') + 10,
                                         lower = get_lower_lims(.x$temp, .x$rate, model_name = 'beta_2012'),
                                         upper = get_upper_lims(.x$temp, .x$rate, model_name = 'beta_2012'),
                                         supp_errors = 'Y',
                                         convergence_count = FALSE)),
         
         boatman = map(data, ~nls_multstart(rate~boatman_2017(temp = temp, rmax, tmin, tmax, a, b),
                                             data = .x,
                                             iter = c(4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'boatman_2017') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'boatman_2017') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'boatman_2017'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'boatman_2017'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         delong =  map(data, ~nls_multstart(rate~delong_2017(temp = temp, c, eb, ef, tm, ehc),
                                             data = .x,
                                             iter = c(4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'delong_2017') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'delong_2017') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'delong_2017'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'delong_2017'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         flinn = map(data, ~nls_multstart(rate~flinn_1991(temp = temp, a,b,c),
                                            data = .x,
                                            iter = c(4,4,4),
                                            start_lower = get_start_vals(.x$temp, .x$rate, model_name = 'flinn_1991') - 10,
                                            start_upper = get_start_vals(.x$temp, .x$rate, model_name = 'flinn_1991') + 10,
                                            lower = get_lower_lims(.x$temp, .x$rate, model_name = 'flinn_1991'),
                                            upper = get_upper_lims(.x$temp, .x$rate, model_name = 'flinn_1991'),
                                            supp_errors = 'Y',
                                            convergence_count = FALSE)),
         
          gaussian =  map(data, ~nls_multstart(rate~gaussian_1987(temp = temp, rmax, topt, a),
                                             data = .x,
                                             iter = c(4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'gaussian_1987') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'gaussian_1987') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'gaussian_1987'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)), 
         
         johnlew =  map(data, ~nls_multstart(rate~johnsonlewin_1946(temp = temp, rO, e, eh, topt),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'johnsonlewin_1946') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'johnsonlewin_1946') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'johnsonlewin_1946'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'johnsonlewin_1946'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),
         
         modified_gauss =  map(data, ~nls_multstart(rate~modifiedgaussian_2006(temp = temp, rmax, topt, a, b),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'modifiedgaussian_2006') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'modifiedgaussian_2006') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'modifiedgaussian_2006'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),   
         
         oneill =  map(data, ~nls_multstart(rate~oneill_1972(temp = temp, rmax, ctmax, topt, q10),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'oneill_1972') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'oneill_1972') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'oneill_1972'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'oneill_1972'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)), 
         
         pawar =  map(data, ~nls_multstart(rate~pawar_2018(temp = temp, r_tref, e, eh, topt, tref = 20),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'pawar_2018') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'pawar_2018') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'pawar_2018'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'pawar_2018'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)), 
         
         ratkowsky =  map(data, ~nls_multstart(rate~ratkowsky_1983(temp = temp, tmin, tmax, a, b),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'ratkowsky_1983') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'ratkowsky_1983') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'ratkowsky_1983'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'ratkowsky_1983'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)), 
         
         sharpeschool =  map(data, ~nls_multstart(rate~sharpeschoolfull_1981(temp = temp, r_tref, e, el, tl, eh, th, tref = 20),
                                             data = .x,
                                             iter = c(4,4,4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'sharpeschoolfull_1981') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'sharpeschoolfull_1981'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),     
         
         weibull =  map(data, ~nls_multstart(rate~weibull_1995(temp = temp, a, topt, b, c),
                                             data = .x,
                                             iter = c(4,4,4,4),
                                             start_lower = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'weibull_1995') - 10,
                                             start_upper = get_start_vals(.x$temp, .x$rate, 
                                                                          model_name = 'weibull_1995') + 10,
                                             lower = get_lower_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                             upper = get_upper_lims(.x$temp, .x$rate, model_name = 'weibull_1995'),
                                             supp_errors = 'Y',
                                             convergence_count = FALSE)),            
         )

# stack models
s_stack <- select(s_fits, -data) %>%
  pivot_longer(., names_to = 'model_name', values_to = 'fit', beta:weibull)

# get parameters using tidy (no longer working)
s_params <- s_stack %>%
  mutate(., est = map(fit, tidy)) %>%
  select(-fit) %>%
  unnest(est)

# get predictions using augment
s_newdata <- tibble(temp = seq(min(s$temp), max(s$temp), length.out = 100))
s_preds <- s_stack %>%
  mutate(., preds = map(fit, augment, newdata = s_newdata)) %>%
  select(-fit) %>%
  unnest(preds)
```

## Compare models using AIC

```{r}
AIC(s_fits[[2]][[1]],s_fits[[3]][[1]], s_fits[[4]][[1]], s_fits[[5]][[1]], s_fits[[6]][[1]], s_fits[[7]][[1]], s_fits[[8]][[1]], s_fits[[9]][[1]], s_fits[[10]][[1]], s_fits[[11]][[1]], s_fits[[12]][[1]], s_fits[[13]][[1]])
```
beta and boatman are by far the best!


## Graphing all:

```{r}
ggplot(s_preds, aes(temp, rate)) +
  geom_point(aes(temp, rate), s) +
  geom_line(aes(temp, .fitted), col = 'blue') +
  facet_wrap(~model_name, scales = 'free', ncol = 5) +
  theme_bw(base_size = 12) +
  theme(legend.position = 'none',
        strip.text = element_text(hjust = 0),
        strip.background = element_blank()) +
  labs(x = 'Temperature (ºC)',
       y = 'Survival rate',
       title = 'Model fit comparison') +
  geom_hline(aes(yintercept = 0), linetype = 2)
```



```{r}
toxaxis_s <- tibble(temp = seq(-5, 50, length.out = 100))

s_preds_two <- s_stack %>%
  mutate(., preds = map(fit, augment, newdata = toxaxis_s)) %>%
  select(-fit) %>%
  unnest(preds)
```


```{r}
survmodelcomp <- ggplot(s_preds_two[c(501:600, 801:900), ], aes(temp, rate)) +
  geom_point(aes(temp, rate), s, color = "black") +
  geom_line(aes(temp, .fitted, color = model_name)) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Survival rate',
       title = 'Model fit comparison', 
       color = "Model name") +
  geom_hline(aes(yintercept = 0), linetype = 2) + 
  scale_color_manual(values = c("purple", "lime green"))

survmodelcomp

```

```{r}
ggsave("~/Desktop/GitHub/Pieris/Figures/survmodelcomp.png", survmodelcomp, width = 8, height = 5)
```

